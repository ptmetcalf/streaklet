{% extends "base.html" %}

{% block title %}Streaklet - Household{% endblock %}

{% block content %}
<div class="container" x-data="householdMaintenance()" x-init="await loadTasks()">
    <header class="page-header">
        <h1>Household Tasks</h1>
        <p class="page-subtitle">Shared tasks for everyone in the household</p>
    </header>

    <!-- View Tabs -->
    <div class="task-tabs" style="margin-bottom: 24px;">
        <button class="tab-button"
                :class="{ 'active': activeView === 'list' }"
                @click="switchView('list')">
            <span>List View</span>
        </button>
        <button class="tab-button"
                :class="{ 'active': activeView === 'calendar' }"
                @click="switchView('calendar')">
            <span>Calendar View</span>
        </button>
    </div>

    <!-- List View -->
    <div x-show="activeView === 'list'">
    <!-- Empty State -->
    <div x-show="!loading && !hasVisibleTasks" class="empty-state" style="text-align: center; padding: 60px 20px;">
        <h2 style="color: #52c41a; margin-bottom: 8px;">All caught up!</h2>
        <p style="color: #666;">No household tasks need attention right now.</p>
    </div>

    <!-- Overdue Tasks Section -->
    <section x-show="overdueTasks.length > 0" class="household-section overdue-section">
        <div class="section-header overdue-header">
            <h2>Overdue Tasks</h2>
            <span class="task-count" x-text="overdueTasks.length"></span>
        </div>
        <div class="household-tasks">
            <template x-for="task in overdueTasks" :key="task.id">
                <div class="household-task-card unified-task-card task-card-household task-card-overdue">
                    <div class="task-main">
                        <div class="task-info">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                <i :class="'mdi mdi-' + (task.icon || 'checkbox-marked-circle')" style="font-size: 24px; color: #ff4d4f;"></i>
                                <h3 x-text="task.title" style="margin: 0;"></h3>
                            </div>
                            <p class="task-description" x-show="task.description" x-text="task.description"></p>
                            <div class="task-meta">
                                <span class="frequency-badge" :class="task.frequency" x-text="formatFrequency(task.frequency)"></span>
                                <span class="completion-info overdue-text">
                                    <template x-if="task.last_completed_at">
                                        <span x-text="`Last done ${task.days_since_completion} days ago by ${task.last_completed_by_profile_name}`"></span>
                                    </template>
                                </span>
                            </div>
                        </div>
                        <div class="task-actions">
                            <button
                                @click="markComplete(task)"
                                :disabled="isCompleting(task.id)"
                                class="btn btn-complete"
                                :class="{ 'disabled': isCompleting(task.id) }">
                                <span x-show="!isCompleting(task.id)">✓ Mark Complete</span>
                                <span x-show="isCompleting(task.id)">⏳ Completing...</span>
                            </button>
                            <button @click="showHistory(task)" class="btn btn-secondary">History</button>
                        </div>
                    </div>
                </div>
            </template>
        </div>
    </section>

    <!-- To-Do Items Section -->
    <section x-show="getTasksByFrequency('todo').length > 0" class="household-section">
        <div class="section-header">
            <h2>To-Do Items</h2>
            <span class="task-count" x-text="getTasksByFrequency('todo').length"></span>
        </div>
        <div class="household-tasks">
            <template x-for="task in getTasksByFrequency('todo')" :key="task.id">
                <div class="household-task-card unified-task-card task-card-household" :class="{ 'task-card-overdue': task.is_overdue }">
                    <div class="task-main">
                        <div class="task-info">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                <i :class="'mdi mdi-' + (task.icon || 'checkbox-marked-circle')" style="font-size: 24px;" :style="{ color: task.is_overdue ? '#ff4d4f' : '#595959' }"></i>
                                <h3 x-text="task.title" style="margin: 0;"></h3>
                            </div>
                            <p class="task-description" x-show="task.description" x-text="task.description"></p>
                            <div class="task-meta">
                                <span class="frequency-badge todo">To-Do</span>
                                <span class="completion-info" :class="{ 'overdue-text': task.is_overdue }">
                                    <template x-if="task.due_date">
                                        <span x-text="formatDueDate(task.due_date)"></span>
                                    </template>
                                    <template x-if="!task.due_date">
                                        <span>No due date</span>
                                    </template>
                                </span>
                            </div>
                        </div>
                        <div class="task-actions">
                            <button
                                @click="markComplete(task)"
                                :disabled="isCompleting(task.id)"
                                class="btn btn-complete"
                                :class="{ 'disabled': isCompleting(task.id) }">
                                <span x-show="!isCompleting(task.id)">✓ Mark Complete</span>
                                <span x-show="isCompleting(task.id)">⏳ Completing...</span>
                            </button>
                            <button @click="showHistory(task)" class="btn btn-secondary">History</button>
                        </div>
                    </div>
                </div>
            </template>
        </div>
    </section>

    <!-- Weekly Tasks -->
    <section x-show="getTasksByFrequency('weekly').length > 0" class="household-section">
        <div class="section-header">
            <h2>Weekly Tasks</h2>
            <span class="task-count" x-text="getTasksByFrequency('weekly').length"></span>
        </div>
        <div class="household-tasks">
            <template x-for="task in getTasksByFrequency('weekly')" :key="task.id">
                <div class="household-task-card unified-task-card task-card-household">
                    <div class="task-main">
                        <div class="task-info">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                <i :class="'mdi mdi-' + (task.icon || 'checkbox-marked-circle')" style="font-size: 24px; color: #0066cc;"></i>
                                <h3 x-text="task.title" style="margin: 0;"></h3>
                            </div>
                            <p class="task-description" x-show="task.description" x-text="task.description"></p>
                            <div class="task-meta">
                                <span class="frequency-badge weekly">Weekly</span>
                                <span class="completion-info">
                                    <template x-if="task.last_completed_at">
                                        <span x-text="`Last done ${task.days_since_completion} days ago by ${task.last_completed_by_profile_name}`"></span>
                                    </template>
                                    <template x-if="!task.last_completed_at">
                                        <span>Never completed</span>
                                    </template>
                                </span>
                            </div>
                        </div>
                        <div class="task-actions">
                            <button
                                @click="markComplete(task)"
                                :disabled="isCompleting(task.id)"
                                class="btn btn-complete"
                                :class="{ 'disabled': isCompleting(task.id) }">
                                <span x-show="!isCompleting(task.id)">✓ Mark Complete</span>
                                <span x-show="isCompleting(task.id)">⏳ Completing...</span>
                            </button>
                            <button @click="showHistory(task)" class="btn btn-secondary">History</button>
                        </div>
                    </div>
                </div>
            </template>
        </div>
    </section>

    <!-- Monthly Tasks -->
    <section x-show="getTasksByFrequency('monthly').length > 0" class="household-section">
        <div class="section-header">
            <h2>Monthly Tasks</h2>
            <span class="task-count" x-text="getTasksByFrequency('monthly').length"></span>
        </div>
        <div class="household-tasks">
            <template x-for="task in getTasksByFrequency('monthly')" :key="task.id">
                <div class="household-task-card unified-task-card task-card-household">
                    <div class="task-main">
                        <div class="task-info">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                <i :class="'mdi mdi-' + (task.icon || 'checkbox-marked-circle')" style="font-size: 24px; color: #5b21b6;"></i>
                                <h3 x-text="task.title" style="margin: 0;"></h3>
                            </div>
                            <p class="task-description" x-show="task.description" x-text="task.description"></p>
                            <div class="task-meta">
                                <span class="frequency-badge monthly">Monthly</span>
                                <span class="completion-info">
                                    <template x-if="task.last_completed_at">
                                        <span x-text="`Last done ${task.days_since_completion} days ago by ${task.last_completed_by_profile_name}`"></span>
                                    </template>
                                    <template x-if="!task.last_completed_at">
                                        <span>Never completed</span>
                                    </template>
                                </span>
                            </div>
                        </div>
                        <div class="task-actions">
                            <button
                                @click="markComplete(task)"
                                :disabled="isCompleting(task.id)"
                                class="btn btn-complete"
                                :class="{ 'disabled': isCompleting(task.id) }">
                                <span x-show="!isCompleting(task.id)">✓ Mark Complete</span>
                                <span x-show="isCompleting(task.id)">⏳ Completing...</span>
                            </button>
                            <button @click="showHistory(task)" class="btn btn-secondary">History</button>
                        </div>
                    </div>
                </div>
            </template>
        </div>
    </section>

    <!-- Quarterly Tasks -->
    <section x-show="getTasksByFrequency('quarterly').length > 0" class="household-section">
        <div class="section-header">
            <h2>Quarterly Tasks</h2>
            <span class="task-count" x-text="getTasksByFrequency('quarterly').length"></span>
        </div>
        <div class="household-tasks">
            <template x-for="task in getTasksByFrequency('quarterly')" :key="task.id">
                <div class="household-task-card unified-task-card task-card-household">
                    <div class="task-main">
                        <div class="task-info">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                <i :class="'mdi mdi-' + (task.icon || 'checkbox-marked-circle')" style="font-size: 24px; color: #d46b08;"></i>
                                <h3 x-text="task.title" style="margin: 0;"></h3>
                            </div>
                            <p class="task-description" x-show="task.description" x-text="task.description"></p>
                            <div class="task-meta">
                                <span class="frequency-badge quarterly">Quarterly</span>
                                <span class="completion-info">
                                    <template x-if="task.last_completed_at">
                                        <span x-text="`Last done ${task.days_since_completion} days ago by ${task.last_completed_by_profile_name}`"></span>
                                    </template>
                                    <template x-if="!task.last_completed_at">
                                        <span>Never completed</span>
                                    </template>
                                </span>
                            </div>
                        </div>
                        <div class="task-actions">
                            <button
                                @click="markComplete(task)"
                                :disabled="isCompleting(task.id)"
                                class="btn btn-complete"
                                :class="{ 'disabled': isCompleting(task.id) }">
                                <span x-show="!isCompleting(task.id)">✓ Mark Complete</span>
                                <span x-show="isCompleting(task.id)">⏳ Completing...</span>
                            </button>
                            <button @click="showHistory(task)" class="btn btn-secondary">History</button>
                        </div>
                    </div>
                </div>
            </template>
        </div>
    </section>

    <!-- Annual Tasks -->
    <section x-show="getTasksByFrequency('annual').length > 0" class="household-section">
        <div class="section-header">
            <h2>Annual Tasks</h2>
            <span class="task-count" x-text="getTasksByFrequency('annual').length"></span>
        </div>
        <div class="household-tasks">
            <template x-for="task in getTasksByFrequency('annual')" :key="task.id">
                <div class="household-task-card unified-task-card task-card-household">
                    <div class="task-main">
                        <div class="task-info">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                <i :class="'mdi mdi-' + (task.icon || 'checkbox-marked-circle')" style="font-size: 24px; color: #7cb305;"></i>
                                <h3 x-text="task.title" style="margin: 0;"></h3>
                            </div>
                            <p class="task-description" x-show="task.description" x-text="task.description"></p>
                            <div class="task-meta">
                                <span class="frequency-badge annual">Annual</span>
                                <span class="completion-info">
                                    <template x-if="task.last_completed_at">
                                        <span x-text="`Last done ${task.days_since_completion} days ago by ${task.last_completed_by_profile_name}`"></span>
                                    </template>
                                    <template x-if="!task.last_completed_at">
                                        <span>Never completed</span>
                                    </template>
                                </span>
                            </div>
                        </div>
                        <div class="task-actions">
                            <button
                                @click="markComplete(task)"
                                :disabled="isCompleting(task.id)"
                                class="btn btn-complete"
                                :class="{ 'disabled': isCompleting(task.id) }">
                                <span x-show="!isCompleting(task.id)">✓ Mark Complete</span>
                                <span x-show="isCompleting(task.id)">⏳ Completing...</span>
                            </button>
                            <button @click="showHistory(task)" class="btn btn-secondary">History</button>
                        </div>
                    </div>
                </div>
            </template>
        </div>
    </section>

    <!-- Empty State -->
    <div x-show="allTasks.length === 0 && !loading" class="empty-state">
        <p>No household tasks yet. Add tasks from Settings.</p>
    </div>

    <!-- Loading State -->
    <div x-show="loading" class="empty-state">
        <p>Loading household tasks...</p>
    </div>
    </div>

    <!-- Calendar View -->
    <div x-show="activeView === 'calendar'">
        <div class="calendar-nav" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
            <button @click="changeMonth(-1)" class="nav-arrow">‹</button>
            <div class="calendar-month-year" x-text="currentMonthYear"></div>
            <button @click="changeMonth(1)" class="nav-arrow">›</button>
        </div>

        <div class="calendar-container">
            <div class="calendar-grid">
                <!-- Weekday headers -->
                <template x-for="day in weekdays" :key="day">
                    <div class="calendar-header" x-text="day"></div>
                </template>

                <!-- Calendar days -->
                <template x-for="day in calendarDays" :key="day.key">
                    <div
                        class="calendar-day household-calendar-day"
                        :class="{
                            'empty': day.isEmpty,
                            'future': day.isFuture,
                            'today': day.isToday,
                            'has-due-tasks': day.hasDueTasks,
                            'has-overdue-tasks': day.hasOverdueTasks,
                            'has-completed-tasks': day.hasCompletedTasks
                        }"
                        @click="selectCalendarDate(day)"
                        :style="day.taskCount > 0 ? {'cursor': 'pointer'} : {}"
                    >
                        <div class="day-number" x-text="day.dayNumber"></div>
                        <div x-show="day.taskCount > 0" class="task-count-badge" x-text="day.taskCount"></div>
                    </div>
                </template>
            </div>

            <div class="calendar-legend" style="margin-top: 20px;">
                <div class="legend-item">
                    <div class="legend-box" style="background: #fff2f0; border: 2px solid #ff4d4f;"></div>
                    <span>Overdue Tasks</span>
                </div>
                <div class="legend-item">
                    <div class="legend-box" style="background: #fffbe6; border: 2px solid #faad14;"></div>
                    <span>Due Soon</span>
                </div>
                <div class="legend-item">
                    <div class="legend-box" style="background: #f6ffed; border: 2px solid #52c41a;"></div>
                    <span>Recently Completed</span>
                </div>
            </div>
        </div>

        <!-- Selected Day Tasks -->
        <div x-show="selectedDay" style="margin-top: 24px;">
            <h3 style="margin-bottom: 16px;" x-text="selectedDateDisplay"></h3>
            <div x-show="selectedDayTasks.length === 0" class="empty-state">
                <p>No household tasks for this date.</p>
            </div>
            <template x-for="task in selectedDayTasks" :key="task.id">
                <div class="household-task-card" :class="{ 'overdue': task.is_overdue }">
                    <div class="task-main">
                        <div class="task-info">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                <i :class="'mdi mdi-' + (task.icon || 'checkbox-marked-circle')" style="font-size: 24px; color: #52c41a;"></i>
                                <h3 x-text="task.title" style="margin: 0;"></h3>
                            </div>
                            <p class="task-description" x-show="task.description" x-text="task.description"></p>
                            <div class="task-meta">
                                <span class="frequency-badge" :class="task.frequency" x-text="task.frequency"></span>
                                <span class="completion-info">
                                    <template x-if="task.last_completed_at">
                                        <span x-text="`Last done ${task.days_since_completion} days ago by ${task.last_completed_by_profile_name}`"></span>
                                    </template>
                                    <template x-if="!task.last_completed_at">
                                        <span>Never completed</span>
                                    </template>
                                </span>
                            </div>
                        </div>
                        <div class="task-actions">
                            <button
                                @click="markComplete(task)"
                                :disabled="isCompleting(task.id)"
                                class="btn btn-complete"
                                :class="{ 'disabled': isCompleting(task.id) }">
                                <span x-show="!isCompleting(task.id)">✓ Mark Complete</span>
                                <span x-show="isCompleting(task.id)">⏳ Completing...</span>
                            </button>
                            <button @click="showHistory(task)" class="btn btn-secondary">History</button>
                        </div>
                    </div>
                </div>
            </template>
        </div>
    </div>

    <!-- History Modal -->
    <div x-show="historyModal.show" class="modal-overlay" @click.self="closeHistory()">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Completion History</h2>
                <button @click="closeHistory()" class="btn-close">✕</button>
            </div>
            <div class="modal-body">
                <h3 x-text="historyModal.task?.title"></h3>
                <p class="task-description" x-show="historyModal.task?.description" x-text="historyModal.task?.description"></p>

                <div x-show="historyModal.history.length === 0" class="empty-state">
                    No completion history yet.
                </div>

                <div x-show="historyModal.history.length > 0" class="history-list">
                    <template x-for="completion in historyModal.history" :key="completion.id">
                        <div class="history-item">
                            <div class="history-date" x-text="formatDate(completion.completed_at)"></div>
                            <div class="history-profile" x-text="`by ${completion.completed_by_profile_name}`"></div>
                            <div x-show="completion.notes" class="history-notes" x-text="completion.notes"></div>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function householdMaintenance() {
    return {
        activeView: 'list', // 'list' or 'calendar'
        allTasks: [],
        allTasksForCalendar: [], // Store ALL tasks for calendar view
        overdueTasks: [],
        loading: true,
        completingTaskIds: new Set(), // Track tasks being completed
        historyModal: {
            show: false,
            task: null,
            history: []
        },

        // Calendar state
        currentYear: new Date().getFullYear(),
        currentMonth: new Date().getMonth() + 1,
        selectedDay: null,
        selectedDayTasks: [],
        weekdays: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],

        async loadTasks() {
            this.loading = true;
            try {
                // NO fetchWithProfile - household tasks are shared!
                const response = await fetch('/api/household/tasks');
                if (response.ok) {
                    const tasks = await response.json();

                    // Store ALL tasks for calendar view
                    this.allTasksForCalendar = tasks;

                    // Only show tasks that need attention in list view:
                    // 1. Never completed (last_completed_at is null)
                    // 2. Overdue (is_overdue is true)
                    const needsAttention = tasks.filter(t =>
                        !t.last_completed_at || t.is_overdue
                    );

                    this.allTasks = needsAttention.filter(t => !t.is_overdue);
                    this.overdueTasks = needsAttention.filter(t => t.is_overdue);
                } else {
                    console.error('Error loading household tasks:', await response.text());
                }
            } catch (error) {
                console.error('Error loading household tasks:', error);
            } finally {
                this.loading = false;
            }
        },

        switchView(view) {
            this.activeView = view;
            if (view === 'calendar') {
                this.selectedDay = null;
                this.selectedDayTasks = [];
            }
        },

                getTasksByFrequency(frequency) {
            return this.allTasks.filter(t => t.frequency === frequency);
        },

        get hasVisibleTasks() {
            return this.overdueTasks.length > 0 || this.allTasks.length > 0;
        },

        formatFrequency(frequency) {
            return frequency.charAt(0).toUpperCase() + frequency.slice(1);
        },

        formatDueDate(dueDateStr) {
            if (!dueDateStr) return '';
            const dueDate = new Date(dueDateStr + 'T00:00:00');
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const diffTime = dueDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays < 0) {
                const absDays = Math.abs(diffDays);
                return `Overdue by ${absDays} day${absDays !== 1 ? 's' : ''}`;
            } else if (diffDays === 0) {
                return 'Due today';
            } else if (diffDays === 1) {
                return 'Due tomorrow';
            } else if (diffDays <= 7) {
                return `Due in ${diffDays} days`;
            } else {
                return `Due ${dueDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`;
            }
        },

        isCompleting(taskId) {
            return this.completingTaskIds.has(taskId);
        },

        async markComplete(task) {
            // Prevent duplicate completions
            if (this.completingTaskIds.has(task.id)) {
                return;
            }

            this.completingTaskIds.add(task.id);
            try {
                // USE fetchWithProfile for completion (attribution)
                const response = await fetchWithProfile(`/api/household/tasks/${task.id}/complete`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    await this.loadTasks();
                } else {
                    console.error('Error marking task complete:', await response.text());
                    alert('Failed to mark task complete');
                }
            } catch (error) {
                console.error('Error marking task complete:', error);
                alert('Failed to mark task complete');
            } finally {
                this.completingTaskIds.delete(task.id);
            }
        },

        async showHistory(task) {
            this.historyModal.task = task;
            this.historyModal.show = true;
            this.historyModal.history = [];

            try {
                const response = await fetch(`/api/household/tasks/${task.id}/history`);
                if (response.ok) {
                    this.historyModal.history = await response.json();
                } else {
                    console.error('Error loading history:', await response.text());
                }
            } catch (error) {
                console.error('Error loading history:', error);
            }
        },

        closeHistory() {
            this.historyModal.show = false;
            this.historyModal.task = null;
            this.historyModal.history = [];
        },

        formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', {
                weekday: 'short',
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: 'numeric',
                minute: '2-digit'
            });
        },

        // Calendar methods
        get currentMonthYear() {
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                              'July', 'August', 'September', 'October', 'November', 'December'];
            return `${monthNames[this.currentMonth - 1]} ${this.currentYear}`;
        },

        get selectedDateDisplay() {
            if (!this.selectedDay) return '';
            return this.selectedDay;
        },

        changeMonth(delta) {
            this.currentMonth += delta;
            if (this.currentMonth > 12) {
                this.currentMonth = 1;
                this.currentYear++;
            } else if (this.currentMonth < 1) {
                this.currentMonth = 12;
                this.currentYear--;
            }
            this.selectedDay = null;
            this.selectedDayTasks = [];
        },

        get calendarDays() {
            const days = [];
            const firstDay = new Date(this.currentYear, this.currentMonth - 1, 1);
            const lastDay = new Date(this.currentYear, this.currentMonth, 0);
            const daysInMonth = lastDay.getDate();

            // Get first day of week (0 = Sunday, convert to 0 = Monday)
            let firstDayWeekday = firstDay.getDay() - 1;
            if (firstDayWeekday < 0) firstDayWeekday = 6;

            const today = new Date().toISOString().split('T')[0];

            // Add empty cells for days before month starts
            for (let i = 0; i < firstDayWeekday; i++) {
                days.push({ isEmpty: true, key: `empty-${i}` });
            }

            // Add actual days
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${this.currentYear}-${String(this.currentMonth).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const tasksForDay = this.getTasksForDate(dateStr);

                const hasOverdue = tasksForDay.some(t => t.is_overdue);
                const hasDueSoon = tasksForDay.some(t => !t.is_overdue && t.days_since_completion >= 5);
                const hasCompleted = tasksForDay.some(t => t.last_completed_at && t.days_since_completion < 5);

                days.push({
                    dayNumber: day,
                    dateStr: dateStr,
                    isEmpty: false,
                    isFuture: dateStr > today,
                    isToday: dateStr === today,
                    taskCount: tasksForDay.length,
                    hasOverdueTasks: hasOverdue,
                    hasDueTasks: hasDueSoon,
                    hasCompletedTasks: hasCompleted && !hasOverdue && !hasDueSoon,
                    key: dateStr
                });
            }

            return days;
        },

        getTasksForDate(dateStr) {
            const today = new Date().toISOString().split('T')[0];
            const THRESHOLDS = {
                'weekly': 7,
                'monthly': 30,
                'quarterly': 90,
                'annual': 365
            };

            return this.allTasksForCalendar.filter(task => {
                // Handle to-do items separately
                if (task.frequency === 'todo') {
                    // If has due_date, show on that date (if not completed)
                    if (task.due_date && !task.is_completed) {
                        return task.due_date === dateStr;
                    }
                    // If no due_date, show on today (if not completed)
                    if (!task.due_date && !task.is_completed) {
                        return dateStr === today;
                    }
                    return false; // Don't show completed to-dos
                }

                // Handle recurring tasks
                if (!task.last_completed_at) {
                    // Never completed - show on current day only
                    return dateStr === today;
                }

                // Calculate when task becomes due based on last completion
                const lastCompleted = new Date(task.last_completed_at);
                const threshold = THRESHOLDS[task.frequency] || 999;
                const dueDate = new Date(lastCompleted);
                dueDate.setDate(dueDate.getDate() + threshold);

                const dueDateStr = dueDate.toISOString().split('T')[0];

                // Show task on its due date
                return dateStr === dueDateStr;
            });
        },

        selectCalendarDate(day) {
            if (day.isEmpty || day.taskCount === 0) return;

            this.selectedDay = new Date(day.dateStr).toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            this.selectedDayTasks = this.getTasksForDate(day.dateStr);
        }
    }
}
</script>

<style>
.page-header {
    margin-bottom: 30px;
}

.page-subtitle {
    font-size: 14px;
    color: #666;
    margin-top: 5px;
}

.household-section {
    margin-bottom: 40px;
}

.section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 2px solid var(--border-color);
}

.section-header h2 {
    font-size: 20px;
    margin: 0;
}

.task-count {
    background: var(--primary-color);
    color: white;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 14px;
    font-weight: 600;
}

.overdue-section {
    background: #fff5f5;
    padding: 20px;
    border-radius: 12px;
    border: 2px solid #ff4d4f;
}

.overdue-header {
    border-bottom-color: #ff4d4f;
}

.overdue-header .task-count {
    background: #ff4d4f;
}

.household-tasks {
    display: grid;
    gap: 15px;
}

.household-task-card {
    background: white;
    border: 2px solid #52c41a;
    border-radius: 12px;
    padding: 20px;
    transition: all 0.2s;
}

.household-task-card.overdue {
    border-color: #ff4d4f;
    background: #fffbfb;
}

.household-task-card:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    transform: translateY(-2px);
}

.task-main {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.task-info h3 {
    margin: 0 0 8px 0;
    font-size: 18px;
    color: #333;
}

.task-description {
    color: #666;
    font-size: 14px;
    margin: 0 0 12px 0;
}

.task-meta {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
}

.frequency-badge {
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
    text-transform: capitalize;
}

.frequency-badge.weekly {
    background: #e6f7ff;
    color: #0066cc;
}

.frequency-badge.monthly {
    background: #f0f5ff;
    color: #5b21b6;
}

.frequency-badge.quarterly {
    background: #fff7e6;
    color: #d46b08;
}

.frequency-badge.annual {
    background: #fcffe6;
    color: #7cb305;
}

.frequency-badge.todo {
    background: #f0f0f0;
    color: #595959;
}

.completion-info {
    font-size: 13px;
    color: #666;
}

.overdue-text {
    color: #ff4d4f;
    font-weight: 600;
}

.task-actions {
    display: flex;
    gap: 10px;
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-complete {
    background: #52c41a;
    color: white;
    flex: 1;
}

.btn-complete:hover {
    background: #45a617;
}

.btn-complete:disabled,
.btn-complete.disabled {
    background: #d9d9d9;
    color: #999;
    cursor: not-allowed;
    opacity: 0.6;
}

.btn-complete:disabled:hover,
.btn-complete.disabled:hover {
    background: #d9d9d9;
}

.btn-secondary {
    background: #f0f0f0;
    color: #666;
}

.btn-secondary:hover {
    background: #e0e0e0;
}

.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #999;
}

/* Modal Styles */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.modal-content {
    background: white;
    border-radius: 16px;
    width: 90%;
    max-width: 600px;
    max-height: 80vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 20px;
    border-bottom: 1px solid var(--border-color);
}

.modal-header h2 {
    margin: 0;
    font-size: 20px;
}

.btn-close {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #999;
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.2s;
}

.btn-close:hover {
    background: #f0f0f0;
    color: #333;
}

.modal-body {
    padding: 20px;
    overflow-y: auto;
}

.modal-body h3 {
    margin: 0 0 8px 0;
    font-size: 18px;
}

.history-list {
    margin-top: 20px;
}

.history-item {
    padding: 15px;
    background: #f9f9f9;
    border-radius: 8px;
    margin-bottom: 10px;
}

.history-date {
    font-weight: 600;
    color: #333;
    margin-bottom: 4px;
}

.history-profile {
    color: #666;
    font-size: 14px;
}

.history-notes {
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px solid #e0e0e0;
    font-size: 13px;
    color: #666;
    font-style: italic;
}

/* Mobile Responsive */
@media (max-width: 768px) {
    .task-main {
        gap: 12px;
    }

    .task-actions {
        flex-direction: column;
    }

    .btn-complete {
        flex: none;
    }

    .modal-content {
        width: 95%;
        max-height: 90vh;
    }
}

/* Calendar View Styles */
.household-calendar-day {
    position: relative;
}

.household-calendar-day.has-overdue-tasks {
    background: #fff2f0;
    border: 2px solid #ff4d4f;
}

.household-calendar-day.has-due-tasks {
    background: #fffbe6;
    border: 2px solid #faad14;
}

.household-calendar-day.has-completed-tasks {
    background: #f6ffed;
    border: 2px solid #52c41a;
}

.task-count-badge {
    position: absolute;
    top: 4px;
    right: 4px;
    background: #1890ff;
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: bold;
}

.household-calendar-day.has-overdue-tasks .task-count-badge {
    background: #ff4d4f;
}

.household-calendar-day.has-due-tasks .task-count-badge {
    background: #faad14;
}

.household-calendar-day.has-completed-tasks .task-count-badge {
    background: #52c41a;
}

.calendar-nav {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
}

.nav-arrow {
    background: white;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    width: 40px;
    height: 40px;
    font-size: 24px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.nav-arrow:hover {
    background: var(--bg-color);
    border-color: var(--primary-color);
}

.calendar-month-year {
    font-size: 18px;
    font-weight: 600;
    color: #333;
}
</style>
{% endblock %}
