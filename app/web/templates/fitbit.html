{% extends "base.html" %}

{% block title %}Streaklet - Fitbit Metrics{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/apexcharts@3.45.1/dist/apexcharts.min.js"></script>
<div class="container" x-data="fitbitMetrics()">
    <header>
        <h1>Fitbit Metrics</h1>
    </header>

    <!-- Not Connected State -->
    <div x-show="!fitbitConnected" style="padding: 40px; text-align: center; border: 1px solid var(--border-color); border-radius: 4px;">
        <div style="font-size: 48px; margin-bottom: 16px;">üìä</div>
        <h2 style="margin-bottom: 8px;">Fitbit Not Connected</h2>
        <p style="color: #666; margin-bottom: 24px;">
            Connect your Fitbit account to view your fitness data here.
        </p>
        <a href="/settings" class="btn-primary" style="display: inline-block; text-decoration: none;">
            Go to Settings to Connect
        </a>
    </div>

    <!-- Connected State -->
    <div x-show="fitbitConnected">
        <!-- Tabs -->
        <div style="display: flex; gap: 16px; margin-bottom: 24px; border-bottom: 2px solid var(--border-color); overflow-x: auto;">
            <button @click="currentTab = 'daily'; loadMetricsForDate()"
                    :class="currentTab === 'daily' ? 'tab-active' : 'tab-inactive'"
                    class="tab-button">
                Daily
            </button>
            <button @click="currentTab = 'overview'; loadOverviewData()"
                    :class="currentTab === 'overview' ? 'tab-active' : 'tab-inactive'"
                    class="tab-button">
                Overview
            </button>
            <button @click="currentTab = 'trends'; loadTrendData()"
                    :class="currentTab === 'trends' ? 'tab-active' : 'tab-inactive'"
                    class="tab-button">
                Trends
            </button>
            <button @click="currentTab = 'compare'; loadComparisonData()"
                    :class="currentTab === 'compare' ? 'tab-active' : 'tab-inactive'"
                    class="tab-button">
                Compare
            </button>
            <button @click="currentTab = 'insights'; loadInsightsData()"
                    :class="currentTab === 'insights' ? 'tab-active' : 'tab-inactive'"
                    class="tab-button">
                Insights
            </button>
        </div>

        <!-- Trends Tab -->
        <div x-show="currentTab === 'trends'">
            <!-- Date Range Selector -->
            <div style="margin-bottom: 24px;">
                <label style="font-weight: 600; display: block; margin-bottom: 8px;">Time Range:</label>
                <select x-model="trendRange" @change="loadTrendData" class="trend-range-select">
                    <option value="7">Last 7 Days</option>
                    <option value="14">Last 14 Days</option>
                    <option value="30">Last 30 Days</option>
                </select>
            </div>

            <!-- Loading State -->
            <div x-show="trendsLoading" style="text-align: center; padding: 40px; color: #666;">
                Loading trends...
            </div>

            <!-- Charts -->
            <div x-show="!trendsLoading" style="display: grid; grid-template-columns: 1fr; gap: 32px;">
                <!-- Steps Chart -->
                <div x-show="visibleMetrics.steps" style="padding: 20px; border: 1px solid var(--border-color); border-radius: 8px; background: white;">
                    <h3 style="margin-bottom: 16px;">Steps</h3>
                    <div id="stepsChart"></div>
                </div>

                <!-- Sleep Chart -->
                <div x-show="visibleMetrics.sleep_minutes" style="padding: 20px; border: 1px solid var(--border-color); border-radius: 8px; background: white;">
                    <h3 style="margin-bottom: 16px;">Sleep</h3>
                    <div id="sleepChart"></div>
                </div>

                <!-- Active Minutes Chart -->
                <div x-show="visibleMetrics.active_minutes" style="padding: 20px; border: 1px solid var(--border-color); border-radius: 8px; background: white;">
                    <h3 style="margin-bottom: 16px;">Active Minutes</h3>
                    <div id="activeMinutesChart"></div>
                </div>

                <!-- Heart Rate Chart -->
                <div x-show="visibleMetrics.resting_heart_rate" style="padding: 20px; border: 1px solid var(--border-color); border-radius: 8px; background: white;">
                    <h3 style="margin-bottom: 16px;">Resting Heart Rate</h3>
                    <div id="heartRateChart"></div>
                </div>
            </div>
        </div>

        <!-- Daily View Tab -->
        <div x-show="currentTab === 'daily'">
            <!-- Date Selector -->
            <div class="date-selector">
                <input type="date"
                       x-model="selectedDate"
                       @change="loadMetricsForDate"
                       :max="today"
                       class="date-input">
                <div class="date-nav-buttons">
                    <button class="btn-secondary" @click="previousDay">‚Üê Prev</button>
                    <button class="btn-secondary" @click="goToToday">Today</button>
                    <button class="btn-secondary" @click="nextDay">Next ‚Üí</button>
                </div>
            </div>

        <!-- Loading State -->
        <div x-show="loading" style="text-align: center; padding: 40px; color: #666;">
            Loading metrics...
        </div>

        <!-- Metrics Display -->
        <div x-show="!loading && Object.keys(metrics).length > 0">
            <!-- Summary Cards -->
            <div class="daily-metrics-grid">
                <!-- Steps -->
                <div x-show="metrics.steps && visibleMetrics.steps" class="metric-card-large">
                    <div class="metric-icon">üëü</div>
                    <div class="metric-value" x-text="formatNumber(metrics.steps?.value)"></div>
                    <div class="metric-label">Steps</div>
                </div>

                <!-- Sleep -->
                <div x-show="metrics.sleep_minutes && visibleMetrics.sleep_minutes" class="metric-card-large">
                    <div class="metric-icon">üò¥</div>
                    <div class="metric-value" x-text="formatSleepHours(metrics.sleep_minutes?.value)"></div>
                    <div class="metric-label">Sleep</div>
                </div>

                <!-- Active Minutes -->
                <div x-show="metrics.active_minutes && visibleMetrics.active_minutes" class="metric-card-large">
                    <div class="metric-icon">üî•</div>
                    <div class="metric-value" x-text="formatNumber(metrics.active_minutes?.value)"></div>
                    <div class="metric-label">Active Minutes</div>
                </div>

                <!-- Calories -->
                <div x-show="metrics.calories_burned && visibleMetrics.calories_burned" class="metric-card-large">
                    <div class="metric-icon">‚ö°</div>
                    <div class="metric-value" x-text="formatNumber(metrics.calories_burned?.value)"></div>
                    <div class="metric-label">Calories Burned</div>
                </div>

                <!-- Distance -->
                <div x-show="metrics.distance && visibleMetrics.distance" class="metric-card-large">
                    <div class="metric-icon">üèÉ</div>
                    <div class="metric-value" x-text="formatDecimal(metrics.distance?.value)"></div>
                    <div class="metric-label">Distance (miles)</div>
                </div>

                <!-- Floors -->
                <div x-show="metrics.floors && visibleMetrics.floors" class="metric-card-large">
                    <div class="metric-icon">ü™ú</div>
                    <div class="metric-value" x-text="formatNumber(metrics.floors?.value)"></div>
                    <div class="metric-label">Floors Climbed</div>
                </div>

                <!-- Sleep Score -->
                <div x-show="metrics.sleep_score && visibleMetrics.sleep_minutes" class="metric-card-large">
                    <div class="metric-icon">‚≠ê</div>
                    <div class="metric-value" x-text="formatNumber(metrics.sleep_score?.value)"></div>
                    <div class="metric-label">Sleep Score</div>
                </div>

                <!-- Resting Heart Rate -->
                <div x-show="metrics.resting_heart_rate && visibleMetrics.resting_heart_rate" class="metric-card-large">
                    <div class="metric-icon">‚ù§Ô∏è</div>
                    <div class="metric-value" x-text="formatNumber(metrics.resting_heart_rate?.value)"></div>
                    <div class="metric-label">Resting HR (bpm)</div>
                </div>

                <!-- HRV (Heart Rate Variability) -->
                <div x-show="metrics.hrv_rmssd && visibleMetrics.hrv" class="metric-card-large">
                    <div class="metric-icon">ü´Ä</div>
                    <div class="metric-value" x-text="formatNumber(metrics.hrv_rmssd?.value)"></div>
                    <div class="metric-label">HRV (ms)</div>
                </div>

                <!-- VO2 Max / Cardio Fitness -->
                <div x-show="metrics.cardio_fitness_score && visibleMetrics.cardio_fitness" class="metric-card-large">
                    <div class="metric-icon">üí™</div>
                    <div class="metric-value" x-text="formatDecimal(metrics.cardio_fitness_score?.value)"></div>
                    <div class="metric-label">VO2 Max</div>
                </div>

                <!-- SpO2 (Blood Oxygen) -->
                <div x-show="metrics.spo2_avg && visibleMetrics.spo2" class="metric-card-large">
                    <div class="metric-icon">ü´Å</div>
                    <div class="metric-value" x-text="formatDecimal(metrics.spo2_avg?.value) + '%'"></div>
                    <div class="metric-label">Blood Oxygen</div>
                </div>

                <!-- Breathing Rate -->
                <div x-show="metrics.breathing_rate && visibleMetrics.breathing_rate" class="metric-card-large">
                    <div class="metric-icon">üå¨Ô∏è</div>
                    <div class="metric-value" x-text="formatDecimal(metrics.breathing_rate?.value)"></div>
                    <div class="metric-label">Breathing Rate (bpm)</div>
                </div>

                <!-- Skin Temperature -->
                <div x-show="metrics.temp_skin && visibleMetrics.temperature" class="metric-card-large">
                    <div class="metric-icon">üå°Ô∏è</div>
                    <div class="metric-value" x-text="formatDecimal(metrics.temp_skin?.value) + '¬∞'"></div>
                    <div class="metric-label">Skin Temp Variation</div>
                </div>

                <!-- Sleep Stages: Deep Sleep -->
                <div x-show="metrics.sleep_deep_minutes && visibleMetrics.sleep_stages" class="metric-card-large">
                    <div class="metric-icon">üåô</div>
                    <div class="metric-value" x-text="formatNumber(metrics.sleep_deep_minutes?.value)"></div>
                    <div class="metric-label">Deep Sleep (min)</div>
                </div>

                <!-- Sleep Stages: Light Sleep -->
                <div x-show="metrics.sleep_light_minutes && visibleMetrics.sleep_stages" class="metric-card-large">
                    <div class="metric-icon">üí§</div>
                    <div class="metric-value" x-text="formatNumber(metrics.sleep_light_minutes?.value)"></div>
                    <div class="metric-label">Light Sleep (min)</div>
                </div>

                <!-- Sleep Stages: REM Sleep -->
                <div x-show="metrics.sleep_rem_minutes && visibleMetrics.sleep_stages" class="metric-card-large">
                    <div class="metric-icon">üí≠</div>
                    <div class="metric-value" x-text="formatNumber(metrics.sleep_rem_minutes?.value)"></div>
                    <div class="metric-label">REM Sleep (min)</div>
                </div>

                <!-- Sleep Stages: Awake Time -->
                <div x-show="metrics.sleep_wake_minutes && visibleMetrics.sleep_stages" class="metric-card-large">
                    <div class="metric-icon">üëÅÔ∏è</div>
                    <div class="metric-value" x-text="formatNumber(metrics.sleep_wake_minutes?.value)"></div>
                    <div class="metric-label">Awake Time (min)</div>
                </div>
            </div>

            <!-- Detailed Metrics Table -->
            <div style="margin-top: 32px;">
                <h2 style="margin-bottom: 16px;">Detailed Metrics</h2>
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 2px solid var(--border-color);">
                            <th style="text-align: left; padding: 12px;">Metric</th>
                            <th style="text-align: right; padding: 12px;">Value</th>
                            <th style="text-align: right; padding: 12px;">Unit</th>
                            <th style="text-align: right; padding: 12px;">Synced At</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="[key, data] in Object.entries(metrics).filter(([k]) => visibleMetrics[k] !== false)" :key="key">
                            <tr style="border-bottom: 1px solid var(--border-color);">
                                <td style="padding: 12px;" x-text="formatMetricName(key)"></td>
                                <td style="text-align: right; padding: 12px; font-weight: 600;" x-text="formatMetricValue(data.value, key)"></td>
                                <td style="text-align: right; padding: 12px; color: #666;" x-text="data.unit || '-'"></td>
                                <td style="text-align: right; padding: 12px; color: #666; font-size: 12px;" x-text="formatSyncTime(data.synced_at)"></td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>

            <!-- No Data State -->
            <div x-show="!loading && Object.keys(metrics).length === 0"
                 style="text-align: center; padding: 40px; color: #666; border: 1px solid var(--border-color); border-radius: 4px;">
                <div style="font-size: 48px; margin-bottom: 16px;">üì≠</div>
                <p>No Fitbit data available for <span x-text="formatDateDisplay(selectedDate)"></span></p>
                <p style="font-size: 14px; margin-top: 8px;">Try selecting a different date or sync your Fitbit data.</p>
            </div>
        </div>

        <!-- Overview Tab -->
        <div x-show="currentTab === 'overview'">
            <div x-show="overviewLoading" style="text-align: center; padding: 40px; color: #666;">
                Loading overview...
            </div>
            <div x-show="!overviewLoading">
                <!-- Stats Summary Cards -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 32px;">
                    <div class="stats-card" x-show="visibleMetrics.steps || visibleMetrics.sleep_minutes || visibleMetrics.active_minutes">
                        <h3>30-Day Averages</h3>
                        <div class="stats-grid">
                            <div class="stat-item" x-show="visibleMetrics.steps">
                                <div class="stat-label">Steps</div>
                                <div class="stat-value" x-text="formatNumber(stats.avg_steps)"></div>
                            </div>
                            <div class="stat-item" x-show="visibleMetrics.sleep_minutes">
                                <div class="stat-label">Sleep</div>
                                <div class="stat-value" x-text="formatSleepHours(stats.avg_sleep)"></div>
                            </div>
                            <div class="stat-item" x-show="visibleMetrics.active_minutes">
                                <div class="stat-label">Active Min</div>
                                <div class="stat-value" x-text="formatNumber(stats.avg_active)"></div>
                            </div>
                        </div>
                    </div>

                    <div class="stats-card" x-show="visibleMetrics.steps || visibleMetrics.sleep_minutes">
                        <h3>Personal Records</h3>
                        <div class="stats-grid">
                            <div class="stat-item" x-show="visibleMetrics.steps">
                                <div class="stat-label">Most Steps</div>
                                <div class="stat-value" x-text="formatNumber(stats.max_steps)"></div>
                                <div class="stat-date" x-text="stats.max_steps_date"></div>
                            </div>
                            <div class="stat-item" x-show="visibleMetrics.sleep_minutes">
                                <div class="stat-label">Best Sleep</div>
                                <div class="stat-value" x-text="formatSleepHours(stats.max_sleep)"></div>
                                <div class="stat-date" x-text="stats.max_sleep_date"></div>
                            </div>
                        </div>
                    </div>

                    <div class="stats-card" x-show="visibleMetrics.steps || visibleMetrics.sleep_minutes">
                        <h3>This Week</h3>
                        <div class="stats-grid">
                            <div class="stat-item" x-show="visibleMetrics.steps">
                                <div class="stat-label">Total Steps</div>
                                <div class="stat-value" x-text="formatNumber(stats.week_steps)"></div>
                                <div class="stat-trend" :class="stats.week_steps_trend >= 0 ? 'trend-up' : 'trend-down'" x-text="formatTrend(stats.week_steps_trend)"></div>
                            </div>
                            <div class="stat-item" x-show="visibleMetrics.sleep_minutes">
                                <div class="stat-label">Avg Sleep</div>
                                <div class="stat-value" x-text="formatSleepHours(stats.week_sleep_avg)"></div>
                                <div class="stat-trend" :class="stats.week_sleep_trend >= 0 ? 'trend-up' : 'trend-down'" x-text="formatTrend(stats.week_sleep_trend)"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Multi-Metric Chart -->
                <div style="padding: 20px; border: 1px solid var(--border-color); border-radius: 8px; background: white; margin-bottom: 24px;">
                    <h3 style="margin-bottom: 16px;">Multi-Metric Overview (Last 30 Days)</h3>
                    <div id="multiMetricChart"></div>
                </div>

                <!-- Goal Progress -->
                <div style="padding: 20px; border: 1px solid var(--border-color); border-radius: 8px; background: white;">
                    <h3 style="margin-bottom: 16px;">Weekly Goals</h3>
                    <div style="display: grid; gap: 16px;">
                        <div class="goal-progress">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span>Steps Goal (70,000/week)</span>
                                <span x-text="Math.round((stats.week_steps / 70000) * 100) + '%'"></span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" :style="`width: ${Math.min((stats.week_steps / 70000) * 100, 100)}%`"></div>
                            </div>
                        </div>
                        <div class="goal-progress">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span>Active Minutes Goal (150/week)</span>
                                <span x-text="Math.round((stats.week_active / 150) * 100) + '%'"></span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" :style="`width: ${Math.min((stats.week_active / 150) * 100, 100)}%`"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Compare Tab -->
        <div x-show="currentTab === 'compare'">
            <div x-show="compareLoading" style="text-align: center; padding: 40px; color: #666;">
                Loading comparison...
            </div>
            <div x-show="!compareLoading">
                <!-- Weekday vs Weekend -->
                <div style="padding: 20px; border: 1px solid var(--border-color); border-radius: 8px; background: white; margin-bottom: 24px;">
                    <h3 style="margin-bottom: 16px;">Weekday vs Weekend Patterns</h3>
                    <div id="weekdayWeekendChart"></div>
                </div>

                <!-- Week Over Week -->
                <div style="padding: 20px; border: 1px solid var(--border-color); border-radius: 8px; background: white; margin-bottom: 24px;">
                    <h3 style="margin-bottom: 16px;">Week Over Week Comparison</h3>
                    <div id="weekOverWeekChart"></div>
                </div>

                <!-- Month Comparison -->
                <div style="padding: 20px; border: 1px solid var(--border-color); border-radius: 8px; background: white;">
                    <h3 style="margin-bottom: 16px;">Monthly Comparison</h3>
                    <div id="monthComparisonChart"></div>
                </div>
            </div>
        </div>

        <!-- Insights Tab -->
        <div x-show="currentTab === 'insights'">
            <div x-show="insightsLoading" style="text-align: center; padding: 40px; color: #666;">
                Analyzing data...
            </div>
            <div x-show="!insightsLoading">
                <!-- Correlation Analysis -->
                <div x-show="visibleMetrics.steps && visibleMetrics.sleep_minutes" style="padding: 20px; border: 1px solid var(--border-color); border-radius: 8px; background: white; margin-bottom: 24px;">
                    <h3 style="margin-bottom: 16px;">Sleep vs Activity Correlation</h3>
                    <div id="correlationChart"></div>
                </div>

                <!-- Distribution Chart -->
                <div x-show="visibleMetrics.steps" style="padding: 20px; border: 1px solid var(--border-color); border-radius: 8px; background: white; margin-bottom: 24px;">
                    <h3 style="margin-bottom: 16px;">Steps Distribution</h3>
                    <div id="distributionChart"></div>
                </div>

                <!-- Key Insights -->
                <div style="padding: 20px; border: 1px solid var(--border-color); border-radius: 8px; background: white;">
                    <h3 style="margin-bottom: 16px;">Key Insights</h3>
                    <div style="display: grid; gap: 12px;">
                        <div class="insight-item" x-show="insights.best_day && visibleMetrics.steps">
                            <span class="insight-icon">üèÜ</span>
                            <span x-text="'Your most active day is ' + insights.best_day"></span>
                        </div>
                        <div class="insight-item" x-show="insights.consistency && visibleMetrics.steps">
                            <span class="insight-icon">üìä</span>
                            <span x-text="'Consistency score: ' + insights.consistency + '%'"></span>
                        </div>
                        <div class="insight-item" x-show="insights.sleep_quality && visibleMetrics.sleep_minutes">
                            <span class="insight-icon">üò¥</span>
                            <span x-text="insights.sleep_quality"></span>
                        </div>
                        <div class="insight-item" x-show="insights.improvement_area && (visibleMetrics.steps || visibleMetrics.sleep_minutes)">
                            <span class="insight-icon">üí°</span>
                            <span x-text="'Opportunity: ' + insights.improvement_area"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.date-selector {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 16px;
    margin-bottom: 24px;
    flex-wrap: wrap;
}

.date-input {
    padding: 12px 16px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    font-size: 16px;
    min-width: 180px;
}

.date-nav-buttons {
    display: flex;
    gap: 8px;
    flex: 1;
    justify-content: flex-end;
}

.date-nav-buttons .btn-secondary {
    padding: 12px 20px;
    white-space: nowrap;
}

.trend-range-select {
    padding: 12px 16px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    font-size: 16px;
    min-width: 200px;
    background: white;
}

@media (max-width: 640px) {
    .date-selector {
        flex-direction: column;
        align-items: stretch;
    }

    .date-input {
        width: 100%;
        font-size: 16px; /* Prevents iOS zoom on focus */
    }

    .date-nav-buttons {
        width: 100%;
        justify-content: stretch;
    }

    .date-nav-buttons .btn-secondary {
        flex: 1;
        padding: 14px 12px;
        font-size: 15px;
    }

    .trend-range-select {
        width: 100%;
        font-size: 16px;
    }
}

.daily-metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-bottom: 32px;
}

@media (max-width: 768px) {
    .daily-metrics-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        margin-bottom: 24px;
    }
}

.metric-card-large {
    padding: 24px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    text-align: center;
    background: var(--background-color);
}

@media (max-width: 768px) {
    .metric-card-large {
        padding: 16px 12px;
    }
}

.metric-icon {
    font-size: 48px;
    margin-bottom: 12px;
}

@media (max-width: 768px) {
    .metric-icon {
        font-size: 32px;
        margin-bottom: 8px;
    }
}

.metric-value {
    font-size: 32px;
    font-weight: 700;
    margin-bottom: 8px;
}

@media (max-width: 768px) {
    .metric-value {
        font-size: 24px;
        margin-bottom: 4px;
    }
}

.metric-label {
    font-size: 14px;
    color: #666;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

@media (max-width: 768px) {
    .metric-label {
        font-size: 11px;
        letter-spacing: 0.3px;
    }
}

.tab-button {
    padding: 12px 24px;
    border: none;
    background: none;
    cursor: pointer;
    font-size: 16px;
    font-weight: 500;
    position: relative;
    transition: color 0.2s;
}

.tab-active {
    color: var(--primary-color);
}

.tab-active::after {
    content: '';
    position: absolute;
    bottom: -2px;
    left: 0;
    right: 0;
    height: 2px;
    background: var(--primary-color);
}

.tab-inactive {
    color: #666;
}

.tab-inactive:hover {
    color: #333;
}

.stats-card {
    padding: 24px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background: white;
}

.stats-card h3 {
    margin: 0 0 16px 0;
    font-size: 14px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: #666;
}

.stats-grid {
    display: grid;
    gap: 16px;
}

.stat-item {
    text-align: center;
}

.stat-label {
    font-size: 12px;
    color: #666;
    margin-bottom: 4px;
}

.stat-value {
    font-size: 24px;
    font-weight: 700;
    color: var(--primary-color);
}

.stat-date {
    font-size: 11px;
    color: #999;
    margin-top: 2px;
}

.stat-trend {
    font-size: 14px;
    font-weight: 600;
    margin-top: 4px;
}

.trend-up {
    color: #10b981;
}

.trend-down {
    color: #ef4444;
}

.progress-bar {
    width: 100%;
    height: 24px;
    background: #e5e7eb;
    border-radius: 12px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--primary-color) 0%, #10b981 100%);
    transition: width 0.5s ease;
    display: flex;
    align-items: center;
    justify-content: flex-end;
    padding-right: 8px;
    color: white;
    font-size: 12px;
    font-weight: 600;
}

.goal-progress {
    padding: 16px;
    background: #f9fafb;
    border-radius: 8px;
}

.insight-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px;
    background: #f9fafb;
    border-radius: 8px;
    border-left: 4px solid var(--primary-color);
}

.insight-icon {
    font-size: 24px;
}

@media (max-width: 768px) {
    .stats-card {
        padding: 16px;
    }

    .stat-value {
        font-size: 20px;
    }
}
</style>

<script>
function fitbitMetrics() {
    return {
        fitbitConnected: false,
        selectedDate: null,
        today: null,
        metrics: {},
        loading: false,

        // Trends state
        currentTab: 'daily',
        trendRange: 7,
        trendsLoading: false,
        charts: {
            steps: null,
            sleep: null,
            activeMinutes: null,
            heartRate: null,
            multiMetric: null,
            weekdayWeekend: null,
            weekOverWeek: null,
            monthComparison: null,
            correlation: null,
            distribution: null
        },

        // Overview state
        overviewLoading: false,
        stats: {
            avg_steps: 0,
            avg_sleep: 0,
            avg_active: 0,
            max_steps: 0,
            max_steps_date: '',
            max_sleep: 0,
            max_sleep_date: '',
            week_steps: 0,
            week_steps_trend: 0,
            week_sleep_avg: 0,
            week_sleep_trend: 0,
            week_active: 0
        },

        // Compare state
        compareLoading: false,
        compareData: {},

        // Insights state
        insightsLoading: false,
        insights: {
            best_day: '',
            consistency: 0,
            sleep_quality: '',
            improvement_area: ''
        },

        // Preferences state
        visibleMetrics: {
            steps: true,
            distance: true,
            floors: true,
            calories_burned: true,
            active_minutes: true,
            sleep_minutes: true,
            sleep_stages: true,
            resting_heart_rate: true,
            hrv: true,
            cardio_fitness: true,
            breathing_rate: true,
            spo2: true,
            temperature: true,
            weight: false,
            body_fat: false,
            water: false
        },

        async init() {
            // Fetch today's date from backend (timezone-aware)
            await this.loadTodayDate();
            await this.checkFitbitConnection();
            if (this.fitbitConnected) {
                await this.loadPreferences();
                await this.loadMetricsForDate();
            }
        },

        async loadPreferences() {
            try {
                const response = await fetchWithProfile('/api/fitbit/preferences/visible-metrics');
                if (response.ok) {
                    const prefs = await response.json();
                    this.visibleMetrics = prefs;
                }
            } catch (error) {
                console.error('Error loading preferences:', error);
            }
        },

        async loadTodayDate() {
            try {
                const response = await fetchWithProfile('/api/days/today');
                if (response.ok) {
                    const data = await response.json();
                    this.today = data.date;
                    this.selectedDate = data.date;
                }
            } catch (error) {
                console.error('Error loading today date:', error);
                // Fallback to local date (but this will have the timezone issue)
                const fallback = new Date().toISOString().split('T')[0];
                this.today = fallback;
                this.selectedDate = fallback;
            }
        },

        async checkFitbitConnection() {
            try {
                const response = await fetchWithProfile('/api/fitbit/connection');
                if (response.ok) {
                    const data = await response.json();
                    this.fitbitConnected = data.connected;
                }
            } catch (error) {
                console.error('Error checking Fitbit connection:', error);
            }
        },

        async loadMetricsForDate() {
            this.loading = true;
            try {
                const response = await fetchWithProfile(`/api/fitbit/daily-summary?date=${this.selectedDate}`);
                if (response.ok) {
                    const data = await response.json();
                    this.metrics = data.metrics || {};
                } else {
                    this.metrics = {};
                }
            } catch (error) {
                console.error('Error loading metrics:', error);
                this.metrics = {};
            } finally {
                this.loading = false;
            }
        },

        // Note: formatDateLocal and other formatters now use global utils.js

        previousDay() {
            const date = parseDateOnly(this.selectedDate);
            date.setDate(date.getDate() - 1);
            this.selectedDate = formatDateLocal(date);
            this.loadMetricsForDate();
        },

        nextDay() {
            const date = parseDateOnly(this.selectedDate);
            date.setDate(date.getDate() + 1);
            const todayDate = parseDateOnly(this.today);
            // Don't go beyond today
            if (date <= todayDate) {
                this.selectedDate = formatDateLocal(date);
                this.loadMetricsForDate();
            }
        },

        goToToday() {
            this.selectedDate = this.today;
            this.loadMetricsForDate();
        },

        async loadTrendData() {
            this.trendsLoading = true;
            try {
                // Calculate date range using timezone-aware today
                // Exclude today to avoid incomplete data affecting trends
                const endDate = parseDateOnly(this.today);
                endDate.setDate(endDate.getDate() - 1); // Use yesterday as end date
                const startDate = parseDateOnly(this.today);
                startDate.setDate(startDate.getDate() - this.trendRange);

                const startStr = formatDateLocal(startDate);
                const endStr = formatDateLocal(endDate);

                // Fetch historical data
                const response = await fetchWithProfile(
                    `/api/fitbit/metrics/history?start_date=${startStr}&end_date=${endStr}&metric_types=steps,sleep_minutes,active_minutes,resting_heart_rate`
                );

                if (response.ok) {
                    const data = await response.json();

                    // Wait for DOM to be ready
                    await this.$nextTick();

                    // Create charts
                    this.createCharts(data.metrics);
                } else {
                    console.error('Failed to load trend data');
                }
            } catch (error) {
                console.error('Error loading trend data:', error);
            } finally {
                this.trendsLoading = false;
            }
        },

        createCharts(metricsData) {
            // Destroy existing charts
            Object.values(this.charts).forEach(chart => {
                if (chart) chart.destroy();
            });

            const chartConfig = {
                steps: {
                    containerId: 'stepsChart',
                    data: metricsData.steps || [],
                    label: 'Steps',
                    color: '#3b82f6',
                    yAxisLabel: 'Steps',
                    formatter: (val) => Math.round(val).toLocaleString(),
                    visible: this.visibleMetrics.steps
                },
                sleep: {
                    containerId: 'sleepChart',
                    data: metricsData.sleep_minutes || [],
                    label: 'Sleep',
                    color: '#8b5cf6',
                    yAxisLabel: 'Hours',
                    transform: (v) => v / 60,
                    formatter: (val) => {
                        const hours = Math.floor(val);
                        const mins = Math.round((val - hours) * 60);
                        return `${hours}h ${mins}m`;
                    },
                    visible: this.visibleMetrics.sleep_minutes
                },
                activeMinutes: {
                    containerId: 'activeMinutesChart',
                    data: metricsData.active_minutes || [],
                    label: 'Active Minutes',
                    color: '#ef4444',
                    yAxisLabel: 'Minutes',
                    formatter: (val) => Math.round(val) + ' min',
                    visible: this.visibleMetrics.active_minutes
                },
                heartRate: {
                    containerId: 'heartRateChart',
                    data: metricsData.resting_heart_rate || [],
                    label: 'Resting HR',
                    color: '#ec4899',
                    yAxisLabel: 'BPM',
                    yAxisMin: 40, // Start at 40 bpm instead of 0 for better visualization
                    formatter: (val) => Math.round(val) + ' bpm',
                    visible: this.visibleMetrics.resting_heart_rate
                }
            };

            Object.keys(chartConfig).forEach(key => {
                const config = chartConfig[key];

                // Skip if metric is hidden
                if (!config.visible) return;

                const container = document.getElementById(config.containerId);
                if (!container) return;

                const categories = config.data.map(d => {
                    const date = new Date(d.date + 'T00:00:00');
                    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                });

                const values = config.data.map(d => {
                    const val = config.transform ? config.transform(d.value) : d.value;
                    return Math.round(val * 100) / 100; // Round to 2 decimals
                });

                const options = {
                    series: [{
                        name: config.label,
                        data: values
                    }],
                    chart: {
                        type: 'line',
                        height: 240,
                        toolbar: {
                            show: false
                        },
                        zoom: {
                            enabled: false
                        },
                        animations: {
                            enabled: true,
                            easing: 'easeinout',
                            speed: 800
                        }
                    },
                    dataLabels: {
                        enabled: false
                    },
                    stroke: {
                        curve: 'straight',
                        width: 2
                    },
                    markers: {
                        size: 3,
                        strokeWidth: 1.5,
                        hover: {
                            size: 5
                        }
                    },
                    colors: [config.color],
                    xaxis: {
                        categories: categories,
                        labels: {
                            style: {
                                fontSize: '12px'
                            }
                        }
                    },
                    yaxis: {
                        min: config.yAxisMin !== undefined ? config.yAxisMin : 0,
                        title: {
                            text: config.yAxisLabel,
                            style: {
                                fontSize: '12px',
                                fontWeight: 500
                            }
                        },
                        labels: {
                            formatter: config.formatter || ((val) => Math.round(val).toLocaleString())
                        }
                    },
                    tooltip: {
                        y: {
                            formatter: config.formatter || ((val) => Math.round(val).toLocaleString())
                        }
                    },
                    grid: {
                        borderColor: '#e5e7eb',
                        strokeDashArray: 3
                    }
                };

                this.charts[key] = new ApexCharts(container, options);
                this.charts[key].render();
            });
        },

        // All formatters now use global utils.js functions:
        // formatNumber, formatDecimal, formatSleepHours, formatMetricValue,
        // formatMetricName, formatDateDisplay, formatSyncTime, formatTrend

        async loadOverviewData() {
            this.overviewLoading = true;
            try {
                // Calculate date ranges
                // Exclude today to avoid incomplete data affecting trends
                const endDate = parseDateOnly(this.today);
                endDate.setDate(endDate.getDate() - 1); // Use yesterday as end date
                const startDate30 = parseDateOnly(this.today);
                startDate30.setDate(startDate30.getDate() - 31); // Adjust start to get 30 complete days

                const startDateWeek = parseDateOnly(this.today);
                startDateWeek.setDate(startDateWeek.getDate() - 8); // Last 7 complete days (excluding today)

                const startDatePrevWeek = parseDateOnly(this.today);
                startDatePrevWeek.setDate(startDatePrevWeek.getDate() - 15); // Previous 7 complete days

                // Fetch 30-day data
                const response30 = await fetchWithProfile(
                    `/api/fitbit/metrics/history?start_date=${formatDateLocal(startDate30)}&end_date=${formatDateLocal(endDate)}&metric_types=steps,sleep_minutes,active_minutes`
                );

                if (response30.ok) {
                    const data30 = await response30.json();

                    // Calculate averages
                    const steps = data30.metrics.steps || [];
                    const sleep = data30.metrics.sleep_minutes || [];
                    const active = data30.metrics.active_minutes || [];

                    this.stats.avg_steps = steps.length > 0 ? steps.reduce((sum, d) => sum + d.value, 0) / steps.length : 0;
                    this.stats.avg_sleep = sleep.length > 0 ? sleep.reduce((sum, d) => sum + d.value, 0) / sleep.length : 0;
                    this.stats.avg_active = active.length > 0 ? active.reduce((sum, d) => sum + d.value, 0) / active.length : 0;

                    // Find max values
                    if (steps.length > 0) {
                        const maxSteps = steps.reduce((max, d) => d.value > max.value ? d : max);
                        this.stats.max_steps = maxSteps.value;
                        this.stats.max_steps_date = new Date(maxSteps.date + 'T00:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    }

                    if (sleep.length > 0) {
                        const maxSleep = sleep.reduce((max, d) => d.value > max.value ? d : max);
                        this.stats.max_sleep = maxSleep.value;
                        this.stats.max_sleep_date = new Date(maxSleep.date + 'T00:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    }

                    // Calculate this week's data
                    const weekSteps = steps.filter(d => new Date(d.date + 'T00:00:00') >= startDateWeek);
                    const weekSleep = sleep.filter(d => new Date(d.date + 'T00:00:00') >= startDateWeek);
                    const weekActive = active.filter(d => new Date(d.date + 'T00:00:00') >= startDateWeek);

                    this.stats.week_steps = weekSteps.reduce((sum, d) => sum + d.value, 0);
                    this.stats.week_sleep_avg = weekSleep.length > 0 ? weekSleep.reduce((sum, d) => sum + d.value, 0) / weekSleep.length : 0;
                    this.stats.week_active = weekActive.reduce((sum, d) => sum + d.value, 0);

                    // Calculate previous week for trend
                    const prevWeekSteps = steps.filter(d => {
                        const date = new Date(d.date + 'T00:00:00');
                        return date >= startDatePrevWeek && date < startDateWeek;
                    });
                    const prevWeekSleep = sleep.filter(d => {
                        const date = new Date(d.date + 'T00:00:00');
                        return date >= startDatePrevWeek && date < startDateWeek;
                    });

                    const prevWeekStepsTotal = prevWeekSteps.reduce((sum, d) => sum + d.value, 0);
                    const prevWeekSleepAvg = prevWeekSleep.length > 0 ? prevWeekSleep.reduce((sum, d) => sum + d.value, 0) / prevWeekSleep.length : 0;

                    this.stats.week_steps_trend = prevWeekStepsTotal > 0 ? ((this.stats.week_steps - prevWeekStepsTotal) / prevWeekStepsTotal) * 100 : 0;
                    this.stats.week_sleep_trend = prevWeekSleepAvg > 0 ? ((this.stats.week_sleep_avg - prevWeekSleepAvg) / prevWeekSleepAvg) * 100 : 0;

                    // Create multi-metric chart
                    await this.$nextTick();
                    this.createMultiMetricChart(data30.metrics);
                }
            } catch (error) {
                console.error('Error loading overview data:', error);
            } finally {
                this.overviewLoading = false;
            }
        },

        createMultiMetricChart(metricsData) {
            if (this.charts.multiMetric) {
                this.charts.multiMetric.destroy();
            }

            const container = document.getElementById('multiMetricChart');
            if (!container) return;

            const steps = metricsData.steps || [];
            const sleep = metricsData.sleep_minutes || [];
            const active = metricsData.active_minutes || [];

            const categories = steps.map(d => {
                const date = new Date(d.date + 'T00:00:00');
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });

            const options = {
                series: [
                    {
                        name: 'Steps',
                        type: 'area',
                        data: steps.map(d => Math.round(d.value))
                    },
                    {
                        name: 'Active Minutes',
                        type: 'line',
                        data: active.map(d => Math.round(d.value))
                    },
                    {
                        name: 'Sleep (hours)',
                        type: 'line',
                        data: sleep.map(d => Math.round((d.value / 60) * 10) / 10)
                    }
                ],
                chart: {
                    height: 350,
                    type: 'line',
                    stacked: false,
                    toolbar: {
                        show: true,
                        tools: {
                            download: true,
                            selection: true,
                            zoom: true,
                            zoomin: true,
                            zoomout: true,
                            pan: true,
                            reset: true
                        }
                    },
                    zoom: {
                        enabled: true
                    }
                },
                stroke: {
                    width: [0, 2, 2],
                    curve: 'smooth'
                },
                fill: {
                    type: ['gradient', 'solid', 'solid'],
                    gradient: {
                        shade: 'light',
                        type: 'vertical',
                        opacityFrom: 0.6,
                        opacityTo: 0.1
                    }
                },
                colors: ['#3b82f6', '#ef4444', '#8b5cf6'],
                xaxis: {
                    categories: categories,
                    labels: {
                        rotate: -45,
                        style: {
                            fontSize: '11px'
                        }
                    }
                },
                yaxis: [
                    {
                        title: {
                            text: 'Steps'
                        },
                        labels: {
                            formatter: (val) => Math.round(val).toLocaleString()
                        }
                    },
                    {
                        opposite: true,
                        title: {
                            text: 'Minutes / Hours'
                        },
                        labels: {
                            formatter: (val) => Math.round(val)
                        }
                    },
                    {
                        show: false
                    }
                ],
                legend: {
                    position: 'top',
                    horizontalAlign: 'center'
                },
                tooltip: {
                    shared: true,
                    intersect: false
                }
            };

            this.charts.multiMetric = new ApexCharts(container, options);
            this.charts.multiMetric.render();
        },

        getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        },

        async loadComparisonData() {
            this.compareLoading = true;
            try {
                // Fetch last 60 days for comparisons
                // Exclude today to avoid incomplete data affecting trends
                const endDate = parseDateOnly(this.today);
                endDate.setDate(endDate.getDate() - 1); // Use yesterday as end date
                const startDate = parseDateOnly(this.today);
                startDate.setDate(startDate.getDate() - 61); // Adjust to get 60 complete days

                const response = await fetchWithProfile(
                    `/api/fitbit/metrics/history?start_date=${formatDateLocal(startDate)}&end_date=${formatDateLocal(endDate)}&metric_types=steps,sleep_minutes,active_minutes`
                );

                if (response.ok) {
                    const data = await response.json();
                    this.compareData = data.metrics;

                    await this.$nextTick();
                    this.createComparisonCharts(data.metrics);
                }
            } catch (error) {
                console.error('Error loading comparison data:', error);
            } finally {
                this.compareLoading = false;
            }
        },

        createComparisonCharts(metricsData) {
            this.createWeekdayWeekendChart(metricsData);
            this.createWeekOverWeekChart(metricsData);
            this.createMonthComparisonChart(metricsData);
        },

        createWeekdayWeekendChart(metricsData) {
            if (this.charts.weekdayWeekend) {
                this.charts.weekdayWeekend.destroy();
            }

            const container = document.getElementById('weekdayWeekendChart');
            if (!container) return;

            const steps = metricsData.steps || [];

            // Separate weekday and weekend data
            const weekdaySteps = [];
            const weekendSteps = [];

            steps.forEach(d => {
                const date = new Date(d.date + 'T00:00:00');
                const dayOfWeek = date.getDay();
                if (dayOfWeek === 0 || dayOfWeek === 6) {
                    weekendSteps.push(d.value);
                } else {
                    weekdaySteps.push(d.value);
                }
            });

            const avgWeekday = weekdaySteps.length > 0 ? weekdaySteps.reduce((sum, v) => sum + v, 0) / weekdaySteps.length : 0;
            const avgWeekend = weekendSteps.length > 0 ? weekendSteps.reduce((sum, v) => sum + v, 0) / weekendSteps.length : 0;

            const options = {
                series: [{
                    name: 'Average Steps',
                    data: [avgWeekday, avgWeekend]
                }],
                chart: {
                    type: 'bar',
                    height: 300,
                    toolbar: {
                        show: false
                    }
                },
                plotOptions: {
                    bar: {
                        borderRadius: 8,
                        horizontal: false,
                        columnWidth: '60%',
                        dataLabels: {
                            position: 'top'
                        }
                    }
                },
                dataLabels: {
                    enabled: true,
                    formatter: (val) => Math.round(val).toLocaleString(),
                    offsetY: -20,
                    style: {
                        fontSize: '12px',
                        colors: ['#333']
                    }
                },
                colors: ['#3b82f6'],
                xaxis: {
                    categories: ['Weekdays', 'Weekends'],
                    labels: {
                        style: {
                            fontSize: '14px',
                            fontWeight: 600
                        }
                    }
                },
                yaxis: {
                    title: {
                        text: 'Average Steps',
                        style: {
                            fontSize: '12px',
                            fontWeight: 500
                        }
                    },
                    labels: {
                        formatter: (val) => Math.round(val).toLocaleString()
                    }
                }
            };

            this.charts.weekdayWeekend = new ApexCharts(container, options);
            this.charts.weekdayWeekend.render();
        },

        createWeekOverWeekChart(metricsData) {
            if (this.charts.weekOverWeek) {
                this.charts.weekOverWeek.destroy();
            }

            const container = document.getElementById('weekOverWeekChart');
            if (!container) return;

            const steps = metricsData.steps || [];

            // Get the start of the current week (Monday)
            const today = new Date();
            const currentDayOfWeek = today.getDay();
            const daysToMonday = currentDayOfWeek === 0 ? 6 : currentDayOfWeek - 1; // Sunday = 6, Monday = 0
            const currentWeekStart = new Date(today);
            currentWeekStart.setDate(today.getDate() - daysToMonday);
            currentWeekStart.setHours(0, 0, 0, 0);

            // Group by week start date (Monday)
            const weeklyData = {};
            steps.forEach(d => {
                const date = new Date(d.date + 'T00:00:00');

                // Calculate Monday of this date's week
                const dayOfWeek = date.getDay();
                const daysToMon = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
                const weekStart = new Date(date);
                weekStart.setDate(date.getDate() - daysToMon);
                weekStart.setHours(0, 0, 0, 0);

                const weekKey = weekStart.toISOString().split('T')[0];

                // Skip current week (incomplete data)
                if (weekStart.getTime() === currentWeekStart.getTime()) {
                    return;
                }

                if (!weeklyData[weekKey]) {
                    weeklyData[weekKey] = {
                        total: 0,
                        count: 0,
                        startDate: weekStart
                    };
                }
                weeklyData[weekKey].total += d.value;
                weeklyData[weekKey].count += 1;
            });

            // Sort by week start date and get last 8 complete weeks
            const weekKeys = Object.keys(weeklyData)
                .sort((a, b) => new Date(b) - new Date(a))
                .slice(0, 8)
                .reverse();

            const weeklyTotals = weekKeys.map(key => weeklyData[key].total);
            const weekLabels = weekKeys.map(key => {
                const date = new Date(key);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });

            const options = {
                series: [{
                    name: 'Weekly Steps',
                    data: weeklyTotals
                }],
                chart: {
                    type: 'line',
                    height: 300,
                    toolbar: {
                        show: false
                    }
                },
                stroke: {
                    curve: 'smooth',
                    width: 3
                },
                markers: {
                    size: 6,
                    strokeWidth: 2,
                    hover: {
                        size: 8
                    }
                },
                colors: ['#3b82f6'],
                xaxis: {
                    categories: weekLabels,
                    title: {
                        text: 'Week Starting',
                        style: {
                            fontSize: '12px',
                            fontWeight: 500
                        }
                    }
                },
                yaxis: {
                    title: {
                        text: 'Total Weekly Steps',
                        style: {
                            fontSize: '12px',
                            fontWeight: 500
                        }
                    },
                    labels: {
                        formatter: (val) => Math.round(val).toLocaleString()
                    }
                },
                tooltip: {
                    y: {
                        formatter: (val) => Math.round(val).toLocaleString() + ' steps'
                    }
                }
            };

            this.charts.weekOverWeek = new ApexCharts(container, options);
            this.charts.weekOverWeek.render();
        },

        createMonthComparisonChart(metricsData) {
            if (this.charts.monthComparison) {
                this.charts.monthComparison.destroy();
            }

            const container = document.getElementById('monthComparisonChart');
            if (!container) return;

            const steps = metricsData.steps || [];

            // Group by month
            const monthlyData = {};
            steps.forEach(d => {
                const date = new Date(d.date + 'T00:00:00');
                const monthKey = date.toLocaleDateString('en-US', { year: 'numeric', month: 'short' });
                if (!monthlyData[monthKey]) {
                    monthlyData[monthKey] = { total: 0, count: 0 };
                }
                monthlyData[monthKey].total += d.value;
                monthlyData[monthKey].count += 1;
            });

            const months = Object.keys(monthlyData).slice(-3);
            const monthlyAverages = months.map(month => Math.round(monthlyData[month].total / monthlyData[month].count));

            const options = {
                series: [{
                    name: 'Daily Average',
                    data: monthlyAverages
                }],
                chart: {
                    type: 'bar',
                    height: 300,
                    toolbar: {
                        show: false
                    }
                },
                plotOptions: {
                    bar: {
                        borderRadius: 8,
                        horizontal: true,
                        dataLabels: {
                            position: 'top'
                        }
                    }
                },
                dataLabels: {
                    enabled: true,
                    formatter: (val) => Math.round(val).toLocaleString(),
                    offsetX: 30,
                    style: {
                        fontSize: '12px',
                        colors: ['#333']
                    }
                },
                colors: ['#10b981'],
                xaxis: {
                    title: {
                        text: 'Average Daily Steps',
                        style: {
                            fontSize: '12px',
                            fontWeight: 500
                        }
                    },
                    labels: {
                        formatter: (val) => Math.round(val).toLocaleString()
                    }
                },
                yaxis: {
                    categories: months
                }
            };

            this.charts.monthComparison = new ApexCharts(container, options);
            this.charts.monthComparison.render();
        },

        async loadInsightsData() {
            this.insightsLoading = true;
            try {
                // Fetch last 90 days for analysis
                // Exclude today to avoid incomplete data affecting trends
                const endDate = parseDateOnly(this.today);
                endDate.setDate(endDate.getDate() - 1); // Use yesterday as end date
                const startDate = parseDateOnly(this.today);
                startDate.setDate(startDate.getDate() - 91); // Adjust to get 90 complete days

                const response = await fetchWithProfile(
                    `/api/fitbit/metrics/history?start_date=${formatDateLocal(startDate)}&end_date=${formatDateLocal(endDate)}&metric_types=steps,sleep_minutes,active_minutes,resting_heart_rate`
                );

                if (response.ok) {
                    const data = await response.json();

                    await this.$nextTick();
                    this.createInsightsCharts(data.metrics);
                    this.calculateInsights(data.metrics);
                }
            } catch (error) {
                console.error('Error loading insights data:', error);
            } finally {
                this.insightsLoading = false;
            }
        },

        createInsightsCharts(metricsData) {
            this.createCorrelationChart(metricsData);
            this.createDistributionChart(metricsData);
        },

        createCorrelationChart(metricsData) {
            // Skip if either metric is hidden
            if (!this.visibleMetrics.steps || !this.visibleMetrics.sleep_minutes) {
                return;
            }

            if (this.charts.correlation) {
                this.charts.correlation.destroy();
            }

            const container = document.getElementById('correlationChart');
            if (!container) return;

            const steps = metricsData.steps || [];
            const sleep = metricsData.sleep_minutes || [];

            // Match dates and create pairs
            const pairs = [];
            steps.forEach(stepData => {
                const sleepData = sleep.find(s => s.date === stepData.date);
                if (sleepData) {
                    pairs.push([stepData.value, sleepData.value / 60]); // Convert sleep to hours
                }
            });

            const options = {
                series: [{
                    name: 'Activity',
                    data: pairs
                }],
                chart: {
                    type: 'scatter',
                    height: 300,
                    toolbar: {
                        show: false
                    },
                    zoom: {
                        enabled: true,
                        type: 'xy'
                    }
                },
                xaxis: {
                    title: {
                        text: 'Steps'
                    },
                    labels: {
                        formatter: (val) => Math.round(val).toLocaleString()
                    }
                },
                yaxis: {
                    title: {
                        text: 'Sleep (hours)'
                    },
                    labels: {
                        formatter: (val) => val.toFixed(1)
                    }
                },
                colors: ['#8b5cf6'],
                tooltip: {
                    custom: function({ seriesIndex, dataPointIndex, w }) {
                        const point = w.config.series[0].data[dataPointIndex];
                        return '<div style="padding: 8px;">' +
                            '<strong>Steps:</strong> ' + Math.round(point[0]).toLocaleString() + '<br>' +
                            '<strong>Sleep:</strong> ' + point[1].toFixed(1) + ' hours' +
                            '</div>';
                    }
                }
            };

            this.charts.correlation = new ApexCharts(container, options);
            this.charts.correlation.render();
        },

        createDistributionChart(metricsData) {
            // Skip if steps metric is hidden
            if (!this.visibleMetrics.steps) {
                return;
            }

            if (this.charts.distribution) {
                this.charts.distribution.destroy();
            }

            const container = document.getElementById('distributionChart');
            if (!container) return;

            const steps = (metricsData.steps || []).map(d => d.value);

            // Create histogram bins
            const bins = [0, 2000, 4000, 6000, 8000, 10000, 12000, 15000, 20000];
            const binCounts = Array(bins.length - 1).fill(0);

            steps.forEach(value => {
                for (let i = 0; i < bins.length - 1; i++) {
                    if (value >= bins[i] && value < bins[i + 1]) {
                        binCounts[i]++;
                        break;
                    }
                }
            });

            const categories = bins.slice(0, -1).map((bin, i) =>
                `${(bin / 1000).toFixed(0)}k-${(bins[i + 1] / 1000).toFixed(0)}k`
            );

            const options = {
                series: [{
                    name: 'Days',
                    data: binCounts
                }],
                chart: {
                    type: 'bar',
                    height: 300,
                    toolbar: {
                        show: false
                    }
                },
                plotOptions: {
                    bar: {
                        borderRadius: 4,
                        columnWidth: '80%'
                    }
                },
                colors: ['#3b82f6'],
                xaxis: {
                    categories: categories,
                    title: {
                        text: 'Steps Range'
                    }
                },
                yaxis: {
                    title: {
                        text: 'Number of Days'
                    }
                },
                tooltip: {
                    y: {
                        formatter: (val) => val + ' days'
                    }
                }
            };

            this.charts.distribution = new ApexCharts(container, options);
            this.charts.distribution.render();
        },

        calculateInsights(metricsData) {
            const steps = metricsData.steps || [];
            const sleep = metricsData.sleep_minutes || [];

            // Only calculate step-related insights if steps are visible
            if (this.visibleMetrics.steps && steps.length > 0) {
                // Find best day of week
                const dayTotals = Array(7).fill(0);
                const dayCounts = Array(7).fill(0);
                steps.forEach(d => {
                    const date = new Date(d.date + 'T00:00:00');
                    const day = date.getDay();
                    dayTotals[day] += d.value;
                    dayCounts[day]++;
                });

                const dayAverages = dayTotals.map((total, i) => dayCounts[i] > 0 ? total / dayCounts[i] : 0);
                const maxDayIndex = dayAverages.indexOf(Math.max(...dayAverages));
                const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                this.insights.best_day = dayNames[maxDayIndex];

                // Calculate consistency (days with > 5000 steps)
                const consistentDays = steps.filter(d => d.value >= 5000).length;
                this.insights.consistency = Math.round((consistentDays / steps.length) * 100);
            } else {
                this.insights.best_day = '';
                this.insights.consistency = 0;
            }

            // Only calculate sleep insights if sleep is visible
            if (this.visibleMetrics.sleep_minutes && sleep.length > 0) {
                const avgSleep = sleep.reduce((sum, d) => sum + d.value, 0) / sleep.length;
                if (avgSleep >= 420) {
                    this.insights.sleep_quality = 'Your sleep duration is excellent (averaging ' + formatSleepHours(avgSleep) + ')';
                } else if (avgSleep >= 360) {
                    this.insights.sleep_quality = 'Your sleep duration is good (averaging ' + formatSleepHours(avgSleep) + ')';
                } else {
                    this.insights.sleep_quality = 'Consider improving sleep duration (averaging ' + formatSleepHours(avgSleep) + ')';
                }
            } else {
                this.insights.sleep_quality = '';
            }

            // Find improvement area based on visible metrics
            const avgSteps = steps.length > 0 ? steps.reduce((sum, d) => sum + d.value, 0) / steps.length : 0;
            const avgSleep = sleep.length > 0 ? sleep.reduce((sum, d) => sum + d.value, 0) / sleep.length : 0;

            if (this.visibleMetrics.steps && avgSteps < 7000) {
                this.insights.improvement_area = 'Increase daily steps (currently averaging ' + Math.round(avgSteps).toLocaleString() + ')';
            } else if (this.visibleMetrics.sleep_minutes && avgSleep < 420) {
                this.insights.improvement_area = 'Focus on getting more sleep';
            } else if (this.visibleMetrics.steps || this.visibleMetrics.sleep_minutes) {
                this.insights.improvement_area = 'Great job! Keep up the consistency';
            } else {
                this.insights.improvement_area = '';
            }
        }
    }
}
</script>
{% endblock %}
