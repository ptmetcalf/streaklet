{% extends "base.html" %}

{% block title %}Streaklet - Today's Checklist{% endblock %}

{% block content %}
<div class="container" x-data="checklist()" x-init="await loadTodayData()">
    <header>
        <div class="header-content">
            <div>
                <h1>Today's Checklist</h1>
                <div class="date" x-text="formattedDate"></div>
            </div>
            <div class="streak-badge" x-text="'Day ' + displayStreakDay"></div>
        </div>
        <div class="progress-bar">
            <div class="progress-fill" :style="`width: ${progress}%`"></div>
        </div>
        <div class="progress-text" x-text="`${completedCount}/${requiredCount} required tasks completed`"></div>
        <div class="milestone-banner" x-show="milestoneMessage" x-text="milestoneMessage"></div>
        <div class="milestone-next" x-show="nextMilestoneMessage" x-text="nextMilestoneMessage"></div>
    </header>

    <div class="checklist">
        <template x-for="task in tasks" :key="task.id">
            <div
                class="task-item"
                :class="{ 'checked': task.checked }"
                @click="toggleTask(task)"
            >
                <div class="checkbox">
                    <svg viewBox="0 0 24 24" fill="none">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                </div>
                <div class="task-content">
                    <div class="task-title" x-text="task.title"></div>
                    <!-- Fitbit Progress Badge -->
                    <div x-show="task.fitbit_metric_type && task.fitbit_current_value != null"
                         class="fitbit-progress"
                         :class="{ 'goal-met': task.fitbit_goal_met }">
                        <span class="fitbit-icon">ðŸ“Š</span>
                        <span x-text="formatFitbitProgress(task)"></span>
                    </div>
                </div>
                <span class="task-badge" :class="{ 'required': task.is_required }" x-show="task.is_required">
                    Required
                </span>
            </div>
        </template>
    </div>

    <div class="milestone-toast" x-show="showToast" x-text="toastMessage"></div>
</div>

<script>
function checklist() {
    return {
        tasks: [],
        streak: 0,
        date: null,
        todayComplete: false,
        lastCompletedDate: null,
        milestoneMessage: '',
        nextMilestoneMessage: '',
        showToast: false,
        toastMessage: '',

        get formattedDate() {
            if (!this.date) return '';
            const d = parseDateOnly(this.date);
            return d.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        },

        get displayStreakDay() {
            const currentStreak = this.streak || 0;
            if (this.todayComplete) {
                return Math.max(1, currentStreak);
            }
            if (!this.date) {
                return Math.max(1, currentStreak);
            }
            if (!this.lastCompletedDate) {
                return 1;
            }

            const today = parseDateOnly(this.date);
            const lastCompleted = parseDateOnly(this.lastCompletedDate);
            const diffDays = Math.round((today - lastCompleted) / (1000 * 60 * 60 * 24));

            if (diffDays === 1) {
                return Math.max(1, currentStreak + 1);
            }
            if (diffDays === 0) {
                return Math.max(1, currentStreak);
            }
            return 1;
        },

        get completedCount() {
            return this.tasks.filter(t => t.checked && t.is_required).length;
        },

        get requiredCount() {
            return this.tasks.filter(t => t.is_required).length;
        },

        get progress() {
            if (this.requiredCount === 0) return 100;
            return Math.round((this.completedCount / this.requiredCount) * 100);
        },

        formatFitbitProgress(task) {
            if (!task.fitbit_current_value || !task.fitbit_goal_value) return '';

            const current = task.fitbit_current_value;
            const goal = task.fitbit_goal_value;
            const unit = task.fitbit_unit || '';

            // Format based on metric type
            if (task.fitbit_metric_type === 'sleep_minutes') {
                const formatMinutes = (mins) => {
                    const hours = Math.floor(mins / 60);
                    const minutes = Math.round(mins % 60);
                    return `${hours}h ${minutes}m`;
                };
                return `${formatMinutes(current)} / ${formatMinutes(goal)}`;
            }

            // Format numbers with commas for readability
            const formatNumber = (num) => {
                if (num >= 1000) {
                    return num.toLocaleString('en-US');
                }
                return Math.round(num).toString();
            };

            const currentStr = formatNumber(current);
            const goalStr = formatNumber(goal);

            // Add unit if available
            if (unit) {
                return `${currentStr} / ${goalStr} ${unit}`;
            }

            return `${currentStr} / ${goalStr}`;
        },

        async loadTodayData() {
            try {
                const response = await fetchWithProfile('/api/days/today');
                const data = await response.json();
                this.tasks = data.tasks;
                this.streak = data.streak.current_streak;
                this.todayComplete = data.streak.today_complete;
                this.lastCompletedDate = data.streak.last_completed_date;
                this.date = data.date;
                this.updateCelebration();
            } catch (error) {
                console.error('Error loading today data:', error);
            }
        },

        async toggleTask(task) {
            const newChecked = !task.checked;

            try {
                const response = await fetchWithProfile(`/api/days/${this.date}/checks/${task.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ checked: newChecked })
                });

                if (response.ok) {
                    task.checked = newChecked;
                    task.checked_at = newChecked ? new Date().toISOString() : null;

                    const streakResponse = await fetchWithProfile('/api/streak');
                    const streakData = await streakResponse.json();
                    this.streak = streakData.current_streak;
                    this.todayComplete = streakData.today_complete;
                    this.lastCompletedDate = streakData.last_completed_date;
                    this.updateCelebration(true);
                }
            } catch (error) {
                console.error('Error updating task:', error);
            }
        },

        updateCelebration(showToast = false) {
            const milestones = [3, 7, 14, 21, 30, 45, 60, 90, 120, 180, 365];
            const current = this.streak || 0;
            const isMilestone = this.todayComplete && milestones.includes(current);

            if (isMilestone) {
                this.milestoneMessage = `Nice! ${current}-day streak.`;
            } else if (this.todayComplete && current > 0) {
                this.milestoneMessage = `Streak alive â€” ${current} days and counting.`;
            } else {
                this.milestoneMessage = '';
            }

            const nextMilestone = milestones.find((value) => value > current);
            if (this.todayComplete && nextMilestone) {
                const remaining = nextMilestone - current;
                this.nextMilestoneMessage = `${remaining} day${remaining === 1 ? '' : 's'} to your next milestone (${nextMilestone}).`;
            } else {
                this.nextMilestoneMessage = '';
            }

            // Trigger confetti when all required tasks completed
            if (showToast && this.todayComplete && this.completedCount === this.requiredCount && this.requiredCount > 0) {
                const confettiEnabled = localStorage.getItem('streaklet_confetti_enabled');
                if (confettiEnabled === null || confettiEnabled === 'true') {
                    this.triggerConfetti(current);
                }
            }

            if (!showToast || !isMilestone || !this.date) {
                return;
            }

            const storageKey = `streaklet_milestone_${this.date}`;
            const lastShown = localStorage.getItem(storageKey);
            if (lastShown === String(current)) {
                return;
            }

            this.toastMessage = `ðŸŽ‰ ${current}-day streak!`;
            this.showToast = true;
            localStorage.setItem(storageKey, String(current));
            setTimeout(() => {
                this.showToast = false;
            }, 3000);
        },

        triggerConfetti(streakLength) {
            if (typeof confetti === 'undefined') return;

            const streak = streakLength || 1;

            // Level 1: Days 1-2 - Simple celebration
            if (streak <= 2) {
                confetti({
                    particleCount: 80,
                    spread: 60,
                    origin: { y: 0.6 },
                    colors: ['#52c41a', '#73d13d', '#95de64']
                });
            }
            // Level 2: Days 3-6 - Enhanced burst
            else if (streak <= 6) {
                confetti({
                    particleCount: 120,
                    spread: 80,
                    origin: { y: 0.6 },
                    colors: ['#52c41a', '#73d13d', '#95de64', '#b7eb8f'],
                    ticks: 200
                });
            }
            // Level 3: Days 7-13 - Double burst (first milestone!)
            else if (streak <= 13) {
                // Center burst
                confetti({
                    particleCount: 150,
                    spread: 100,
                    origin: { y: 0.6 },
                    colors: ['#52c41a', '#73d13d', '#95de64', '#b7eb8f', '#d9f7be']
                });
                // Side cannons
                setTimeout(() => {
                    confetti({
                        particleCount: 80,
                        angle: 60,
                        spread: 55,
                        origin: { x: 0, y: 0.6 },
                        colors: ['#3b82f6', '#667eea', '#764ba2']
                    });
                    confetti({
                        particleCount: 80,
                        angle: 120,
                        spread: 55,
                        origin: { x: 1, y: 0.6 },
                        colors: ['#f5222d', '#fa541c', '#fa8c16']
                    });
                }, 250);
            }
            // Level 4: Days 14-29 - Triple burst with rainbow
            else if (streak <= 29) {
                const colors = ['#ff0000', '#ff7f00', '#ffff00', '#00ff00', '#0000ff', '#4b0082', '#9400d3'];

                // Main burst
                confetti({
                    particleCount: 200,
                    spread: 120,
                    origin: { y: 0.6 },
                    colors: colors,
                    ticks: 300
                });

                // Left and right cannons
                [0, 250, 500].forEach((delay) => {
                    setTimeout(() => {
                        confetti({
                            particleCount: 100,
                            angle: 60,
                            spread: 70,
                            origin: { x: 0, y: 0.7 },
                            colors: colors
                        });
                        confetti({
                            particleCount: 100,
                            angle: 120,
                            spread: 70,
                            origin: { x: 1, y: 0.7 },
                            colors: colors
                        });
                    }, delay);
                });
            }
            // Level 5: Days 30-59 - Fireworks style
            else if (streak <= 59) {
                const colors = ['#ff0000', '#ff7f00', '#ffff00', '#00ff00', '#0000ff', '#4b0082', '#9400d3'];

                // Continuous bursts from different positions
                const positions = [
                    { x: 0.2, y: 0.5 },
                    { x: 0.5, y: 0.4 },
                    { x: 0.8, y: 0.5 },
                    { x: 0.35, y: 0.6 },
                    { x: 0.65, y: 0.6 }
                ];

                positions.forEach((pos, i) => {
                    setTimeout(() => {
                        confetti({
                            particleCount: 150,
                            spread: 360,
                            startVelocity: 30,
                            decay: 0.9,
                            scalar: 1.2,
                            origin: pos,
                            colors: colors,
                            shapes: ['circle', 'square']
                        });
                    }, i * 150);
                });
            }
            // Level 6: Days 60-89 - Epic multi-wave
            else if (streak <= 89) {
                const duration = 3000;
                const animationEnd = Date.now() + duration;
                const colors = ['#ff0000', '#ff7f00', '#ffff00', '#00ff00', '#0000ff', '#4b0082', '#9400d3', '#ff1493'];

                (function frame() {
                    confetti({
                        particleCount: 7,
                        angle: 60,
                        spread: 55,
                        origin: { x: 0 },
                        colors: colors
                    });
                    confetti({
                        particleCount: 7,
                        angle: 120,
                        spread: 55,
                        origin: { x: 1 },
                        colors: colors
                    });

                    if (Date.now() < animationEnd) {
                        requestAnimationFrame(frame);
                    }
                }());

                // Center explosions
                setTimeout(() => {
                    confetti({
                        particleCount: 200,
                        spread: 200,
                        origin: { y: 0.5 },
                        colors: colors,
                        shapes: ['circle', 'square', 'star']
                    });
                }, 500);
            }
            // Level 7: Days 90+ - ULTIMATE CELEBRATION
            else {
                const duration = 4000;
                const animationEnd = Date.now() + duration;
                const colors = ['#ff0000', '#ff7f00', '#ffff00', '#00ff00', '#0000ff', '#4b0082', '#9400d3', '#ff1493', '#ffd700'];

                // Continuous side cannons
                (function frame() {
                    confetti({
                        particleCount: 10,
                        angle: 60,
                        spread: 55,
                        origin: { x: 0 },
                        colors: colors,
                        shapes: ['circle', 'square', 'star']
                    });
                    confetti({
                        particleCount: 10,
                        angle: 120,
                        spread: 55,
                        origin: { x: 1 },
                        colors: colors,
                        shapes: ['circle', 'square', 'star']
                    });

                    if (Date.now() < animationEnd) {
                        requestAnimationFrame(frame);
                    }
                }());

                // Multiple explosions at different times
                [0, 500, 1000, 1500, 2000, 2500].forEach((delay) => {
                    setTimeout(() => {
                        confetti({
                            particleCount: 250,
                            spread: 360,
                            startVelocity: 40,
                            decay: 0.85,
                            scalar: 1.5,
                            origin: { x: 0.5, y: 0.4 },
                            colors: colors,
                            shapes: ['circle', 'square', 'star']
                        });
                    }, delay);
                });

                // Emoji confetti
                setTimeout(() => {
                    confetti({
                        particleCount: 50,
                        spread: 100,
                        origin: { y: 0.6 },
                        scalar: 2,
                        shapes: ['circle'],
                        colors: ['#FFD700', '#FFA500', '#FF69B4']
                    });
                }, 1000);
            }
        }
    }
}
</script>

<style>
.task-content {
    display: flex;
    flex-direction: column;
    gap: 4px;
    flex: 1;
}

.task-title {
    font-weight: 500;
}

.fitbit-progress {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: 12px;
    color: #666;
    padding: 2px 8px;
    background: #f0f0f0;
    border-radius: 12px;
    width: fit-content;
}

.fitbit-progress.goal-met {
    background: #e8f5e9;
    color: #2e7d32;
    font-weight: 500;
}

.fitbit-icon {
    font-size: 14px;
    line-height: 1;
}
</style>
{% endblock %}
