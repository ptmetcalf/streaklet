{% extends "base.html" %}

{% block title %}Streaklet - Today's Checklist{% endblock %}

{% block content %}
<div class="container" x-data="checklist()" x-init="await loadAllTasks()">
    <header>
        <div class="header-content">
            <div>
                <h1>Today's Checklist</h1>
                <div class="date" x-text="formattedDate"></div>
            </div>
            <div class="streak-badge" x-text="'Day ' + displayStreakDay"></div>
        </div>
        <div class="progress-bar">
            <div class="progress-fill" :style="`width: ${progress}%`"></div>
        </div>
        <div class="progress-text" x-text="`${completedCount}/${requiredCount} required tasks completed`"></div>
        <div class="milestone-banner" x-show="milestoneMessage" x-text="milestoneMessage"></div>
        <div class="milestone-next" x-show="nextMilestoneMessage" x-text="nextMilestoneMessage"></div>
    </header>

    <!-- Task Type Tabs -->
    <div class="task-tabs">
        <button class="tab-button"
                :class="{ 'active': activeTab === 'daily' }"
                @click="switchTab('daily')">
            <span>Daily</span>
            <span class="badge-count" x-show="dailyCount > 0" x-text="dailyCount"></span>
        </button>
        <button class="tab-button"
                :class="{ 'active': activeTab === 'punch_list' }"
                @click="switchTab('punch_list')">
            <span>Todo List</span>
            <span class="badge-count" x-show="punchListCount > 0" x-text="punchListCount"></span>
        </button>
    </div>

    <!-- Daily Tasks Tab -->
    <div x-show="activeTab === 'daily'" class="tab-content">
        <div class="checklist">
            <template x-for="task in dailyTasks" :key="task.id">
                <div class="unified-task-card task-card-daily" :class="{ 'task-card-checked': task.checked }">
                    <div class="task-card-header">
                        <i :class="'mdi mdi-' + (task.icon || 'check-circle')" class="task-card-icon"></i>
                        <div class="task-card-title" x-text="task.title"></div>
                    </div>

                    <!-- Metadata badges -->
                    <div class="task-card-metadata">
                        <span class="task-badge badge-required" x-show="task.is_required">Required</span>

                        <!-- Fitbit Progress -->
                        <template x-if="task.fitbit_metric_type && task.fitbit_current_value != null">
                            <div class="fitbit-progress" :class="{ 'goal-met': task.fitbit_goal_met }">
                                <span class="fitbit-icon">ðŸ“Š</span>
                                <span x-text="formatFitbitProgress(task)"></span>
                            </div>
                        </template>

                        <!-- Per-Task Streak -->
                        <template x-if="task.task_streak && task.task_streak > 0">
                            <div class="task-streak-badge" :class="getStreakBadgeClass(task.task_streak)"
                                 :title="`${task.task_streak}-day streak${task.task_streak_milestone ? ' â€¢ Next: ' + task.task_streak_milestone + ' days' : ''}`">
                                <span class="streak-icon">ðŸ”¥</span>
                                <span x-text="task.task_streak"></span>
                            </div>
                        </template>
                    </div>

                    <!-- Action buttons -->
                    <div class="task-card-actions">
                        <button @click="toggleTask(task)"
                                class="btn-task-action btn-task-complete"
                                :class="{ 'task-card-checked': task.checked }">
                            <span x-show="!task.checked">âœ“ Mark Complete</span>
                            <span x-show="task.checked">â†¶ Undo</span>
                        </button>
                    </div>
                </div>
            </template>

            <!-- Add New Daily Task Card -->
            <div class="add-task-card" @click="showAddDailyTaskModal = true">
                <i class="mdi mdi-plus-circle" style="font-size: 32px; color: var(--primary-color);"></i>
                <div class="add-task-card__text">
                    <div class="add-task-card__title">Add New Daily Task</div>
                    <div class="add-task-card__subtitle">Create a new recurring daily task</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Todo List Tab -->
    <div x-show="activeTab === 'punch_list'" class="tab-content">
        <!-- Active/Incomplete Todo Items -->
        <div class="checklist">
            <template x-for="task in activePunchListTasks" :key="task.id">
                <div class="unified-task-card task-card-punch-list" :class="{ 'task-card-overdue': isOverdue(task) }">
                    <div class="task-card-header">
                        <i :class="'mdi mdi-' + (task.icon || 'check-circle')" class="task-card-icon"></i>
                        <div class="task-card-title" x-text="task.title"></div>
                    </div>

                    <div class="task-card-metadata" x-show="task.due_date">
                        <span class="task-badge" x-text="formatDueDate(task.due_date)"
                              :class="{ 'badge-overdue': isOverdue(task) }"></span>
                    </div>

                    <div class="task-card-actions">
                        <button @click="togglePunchListTask(task)" class="btn-task-action btn-task-complete">
                            âœ“ Mark Complete
                        </button>
                    </div>
                </div>
            </template>

            <!-- Add New Todo Card -->
            <div class="add-task-card" @click="showAddTodoModal = true">
                <i class="mdi mdi-plus-circle" style="font-size: 32px; color: var(--primary-color);"></i>
                <div class="add-task-card__text">
                    <div class="add-task-card__title">Add New Todo</div>
                    <div class="add-task-card__subtitle">Create a one-off task with optional due date</div>
                </div>
            </div>

            <!-- Empty state -->
            <div x-show="activePunchListTasks.length === 0 && completedPunchListTasks.length === 0" class="empty-state">
                <p>No todo items yet.</p>
            </div>
        </div>

        <!-- Completed section (collapsible) -->
        <div x-show="completedPunchListTasks.length > 0" style="margin-top: 16px;">
            <button @click="showCompletedTodos = !showCompletedTodos" class="btn btn--secondary btn--block">
                <span>
                    <span x-text="`Completed (${completedPunchListTasks.length})`"></span>
                    <span style="font-size: 12px; margin-left: 8px; opacity: 0.7;">auto-archive after 7 days</span>
                </span>
                <svg :style="showCompletedTodos ? 'transform: rotate(180deg)' : ''" style="width: 16px; height: 16px; transition: transform 0.2s;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
            </button>

            <div x-show="showCompletedTodos" x-collapse style="margin-top: 8px;">
                <template x-for="task in completedPunchListTasks" :key="task.id">
                    <div class="unified-task-card task-card-punch-list task-card-checked">
                        <div class="task-card-header">
                            <i :class="'mdi mdi-' + (task.icon || 'check-circle')" class="task-card-icon"></i>
                            <div class="task-card-title" x-text="task.title"></div>
                        </div>
                        <div class="task-card-metadata" x-show="task.completed_at">
                            <span x-text="`Completed ${formatCompletedDate(task.completed_at)}`"></span>
                        </div>
                        <div class="task-card-actions">
                            <button @click="togglePunchListTask(task)" class="btn-task-action btn-task-secondary">
                                â†¶ Restore
                            </button>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </div>

    <!-- Add Daily Task Modal -->
    <div x-show="showAddDailyTaskModal" class="modal-overlay" @click.self="closeAddDailyTaskModal()" @keydown.escape.window="showAddDailyTaskModal && closeAddDailyTaskModal()">
        <div class="modal-content modal-content--md">
            <div class="modal-header">
                <h2>Add New Daily Task</h2>
                <button @click="closeAddDailyTaskModal()" class="btn-close">âœ•</button>
            </div>
            <div class="modal-body">
                <form @submit.prevent="submitDailyTask()">
                    <div class="form-field">
                        <label class="form-field__label form-field__label--required">Title</label>
                        <input type="text" class="form-field__input" x-model="newDailyTask.title" placeholder="e.g., Exercise for 30 minutes" required>
                    </div>
                    <div class="form-field">
                        <label class="form-field__label">Icon</label>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <button type="button" class="btn btn--secondary" @click="showDailyIconPicker = true">
                                <i :class="'mdi mdi-' + (newDailyTask.icon || 'check-circle')" style="font-size: 20px;"></i>
                                <span>Choose Icon</span>
                            </button>
                            <template x-if="newDailyTask.icon">
                                <button type="button" class="btn btn--secondary btn--sm" @click="newDailyTask.icon = null">Clear</button>
                            </template>
                        </div>
                    </div>
                    <div class="form-field">
                        <label class="form-field__checkbox-label">
                            <input type="checkbox" class="form-field__checkbox" x-model="newDailyTask.is_required">
                            <span>Required for daily completion</span>
                        </label>
                    </div>
                    <div class="form-field">
                        <label class="form-field__checkbox-label">
                            <input type="checkbox" class="form-field__checkbox" x-model="newDailyTask.is_active">
                            <span>Enabled</span>
                        </label>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button type="submit" class="btn btn--primary" :disabled="!newDailyTask.title.trim()">Add Task</button>
                        <button type="button" class="btn btn--secondary" @click="closeAddDailyTaskModal()">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Todo Modal -->
    <div x-show="showAddTodoModal" class="modal-overlay" @click.self="closeAddTodoModal()" @keydown.escape.window="showAddTodoModal && closeAddTodoModal()">
        <div class="modal-content modal-content--md">
            <div class="modal-header">
                <h2>Add New Todo</h2>
                <button @click="closeAddTodoModal()" class="btn-close">âœ•</button>
            </div>
            <div class="modal-body">
                <form @submit.prevent="submitTodo()">
                    <div class="form-field">
                        <label class="form-field__label form-field__label--required">Title</label>
                        <input type="text" class="form-field__input" x-model="newTodo.title" placeholder="e.g., Call dentist, Fix faucet" required>
                    </div>
                    <div class="form-field">
                        <label class="form-field__label">Icon</label>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <button type="button" class="btn btn--secondary" @click="showTodoIconPicker = true">
                                <i :class="'mdi mdi-' + (newTodo.icon || 'check-circle')" style="font-size: 20px;"></i>
                                <span>Choose Icon</span>
                            </button>
                            <template x-if="newTodo.icon">
                                <button type="button" class="btn btn--secondary btn--sm" @click="newTodo.icon = null">Clear</button>
                            </template>
                        </div>
                    </div>
                    <div class="form-field">
                        <label class="form-field__label">Due Date (optional)</label>
                        <input type="date" class="form-field__input" x-model="newTodo.due_date">
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button type="submit" class="btn btn--primary" :disabled="!newTodo.title.trim()">Add Todo</button>
                        <button type="button" class="btn btn--secondary" @click="closeAddTodoModal()">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Icon Picker Modal for Daily Tasks -->
    <div x-show="showDailyIconPicker" class="modal-overlay" @click.self="showDailyIconPicker = false">
        <div class="modal-content modal-content--md modal-content--scrollable" @click.stop>
            <div class="modal-header">
                <h2>Choose an Icon</h2>
                <button @click="showDailyIconPicker = false" class="btn-close">âœ•</button>
            </div>
            <div class="modal-body">
                <input type="text" class="form-field__input" x-model="dailyIconSearch" placeholder="Search icons..." style="margin-bottom: 16px;">
                <div x-show="!hasPersonalIconResults" style="text-align: center; padding: 20px; color: #999;">
                    No icons found matching "<span x-text="dailyIconSearch"></span>"
                </div>
                <template x-for="(icons, category) in filteredPersonalIcons" :key="category">
                    <div x-show="icons.length > 0" style="margin-bottom: 20px;">
                        <h4 style="margin-bottom: 10px; color: #666; font-size: 13px; text-transform: uppercase;" x-text="category"></h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 8px;">
                            <template x-for="icon in icons" :key="icon">
                                <button type="button" @click="selectDailyIcon(icon)" class="icon-picker-btn">
                                    <i :class="'mdi mdi-' + icon" style="font-size: 24px;"></i>
                                </button>
                            </template>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </div>

    <!-- Icon Picker Modal for Todo -->
    <div x-show="showTodoIconPicker" class="modal-overlay" @click.self="showTodoIconPicker = false">
        <div class="modal-content modal-content--md modal-content--scrollable" @click.stop>
            <div class="modal-header">
                <h2>Choose an Icon</h2>
                <button @click="showTodoIconPicker = false" class="btn-close">âœ•</button>
            </div>
            <div class="modal-body">
                <input type="text" class="form-field__input" x-model="todoIconSearch" placeholder="Search icons..." style="margin-bottom: 16px;">
                <div x-show="!hasPersonalIconResults" style="text-align: center; padding: 20px; color: #999;">
                    No icons found matching "<span x-text="todoIconSearch"></span>"
                </div>
                <template x-for="(icons, category) in filteredPersonalIcons" :key="category">
                    <div x-show="icons.length > 0" style="margin-bottom: 20px;">
                        <h4 style="margin-bottom: 10px; color: #666; font-size: 13px; text-transform: uppercase;" x-text="category"></h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 8px;">
                            <template x-for="icon in icons" :key="icon">
                                <button type="button" @click="selectTodoIcon(icon)" class="icon-picker-btn">
                                    <i :class="'mdi mdi-' + icon" style="font-size: 24px;"></i>
                                </button>
                            </template>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </div>

    <div class="milestone-toast" x-show="showToast" x-text="toastMessage"></div>
</div>

<script>
function checklist() {
    return {
        // Daily tasks state
        tasks: [],
        dailyTasks: [],
        streak: 0,
        date: null,
        todayComplete: false,
        lastCompletedDate: null,
        milestoneMessage: '',
        nextMilestoneMessage: '',
        showToast: false,
        toastMessage: '',

        // Punch list state
        punchListTasks: [],
        showCompletedTodos: false,

        // Tab state
        activeTab: 'daily',

        // Add task modals state
        showAddDailyTaskModal: false,
        showAddTodoModal: false,
        showDailyIconPicker: false,
        showTodoIconPicker: false,
        dailyIconSearch: '',
        todoIconSearch: '',

        // New task forms
        newDailyTask: {
            title: '',
            icon: null,
            is_required: true,
            is_active: true
        },
        newTodo: {
            title: '',
            icon: null,
            due_date: null
        },

        // Personal icon categories (shared for both modals)
        personalIconCategories: window.iconPickerUtils?.personalIcons || {},

        // Badge counts
        get dailyCount() {
            return this.dailyTasks.filter(t => !t.checked && t.is_required).length;
        },
        get punchListCount() {
            return this.punchListTasks.filter(t => !t.completed_at).length;
        },
        get activePunchListTasks() {
            return this.punchListTasks.filter(t => !t.completed_at);
        },
        get completedPunchListTasks() {
            return this.punchListTasks.filter(t => t.completed_at);
        },

        get formattedDate() {
            if (!this.date) return '';
            const d = parseDateOnly(this.date);
            return d.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        },

        get displayStreakDay() {
            const currentStreak = this.streak || 0;
            if (this.todayComplete) {
                return Math.max(1, currentStreak);
            }
            if (!this.date) {
                return Math.max(1, currentStreak);
            }
            if (!this.lastCompletedDate) {
                return 1;
            }

            const today = parseDateOnly(this.date);
            const lastCompleted = parseDateOnly(this.lastCompletedDate);
            const diffDays = Math.round((today - lastCompleted) / (1000 * 60 * 60 * 24));

            if (diffDays === 1) {
                return Math.max(1, currentStreak + 1);
            }
            if (diffDays === 0) {
                return Math.max(1, currentStreak);
            }
            return 1;
        },

        get completedCount() {
            return this.tasks.filter(t => t.checked && t.is_required).length;
        },

        get requiredCount() {
            return this.tasks.filter(t => t.is_required).length;
        },

        get progress() {
            if (this.requiredCount === 0) return 100;
            return Math.round((this.completedCount / this.requiredCount) * 100);
        },

        // Icon picker computed properties
        get filteredPersonalIcons() {
            const searchTerm = (this.showDailyIconPicker ? this.dailyIconSearch : this.todoIconSearch).toLowerCase();
            return window.iconPickerUtils?.filterCategories(this.personalIconCategories, searchTerm) || {};
        },

        get hasPersonalIconResults() {
            return window.iconPickerUtils?.hasVisibleIcons(this.personalIconCategories, this.showDailyIconPicker ? this.dailyIconSearch : this.todoIconSearch) || false;
        },

        // Tab switching
        switchTab(tab) {
            this.activeTab = tab;
            localStorage.setItem('streaklet_last_tab', tab);
        },

        // Load all task types
        async loadAllTasks() {
            await this.loadDailyTasks();
            await this.loadPunchListTasks();

            // Restore last active tab
            const lastTab = localStorage.getItem('streaklet_last_tab');
            if (lastTab && ['daily', 'punch_list'].includes(lastTab)) {
                this.activeTab = lastTab;
            }
        },

        async loadDailyTasks() {
            try {
                const data = await api.daily.today();
                this.tasks = data.tasks;
                this.dailyTasks = data.tasks;  // For now, all tasks from /api/days/today are daily
                this.streak = data.streak.current_streak;
                this.todayComplete = data.streak.today_complete;
                this.lastCompletedDate = data.streak.last_completed_date;
                this.date = data.date;
                this.updateCelebration();
            } catch (error) {
                console.error('Error loading daily tasks:', error);
            }
        },

        async loadPunchListTasks() {
            try {
                this.punchListTasks = await api.punchList.list();
            } catch (error) {
                console.error('Error loading punch list tasks:', error);
            }
        },

        async toggleTask(task) {
            const newChecked = !task.checked;
            const previousStreak = task.task_streak || 0;

            try {
                await api.daily.toggleTask(this.date, task.id, newChecked);
                task.checked = newChecked;
                task.checked_at = newChecked ? new Date().toISOString() : null;

                // Reload to get updated streak data
                await this.loadDailyTasks();

                // Find the updated task
                const updatedTask = this.tasks.find(t => t.id === task.id);
                const newStreak = updatedTask?.task_streak || 0;

                // Trigger per-task celebration if milestone reached
                if (newChecked && newStreak > previousStreak) {
                    this.celebrateTaskMilestone(updatedTask, newStreak);
                }

                // Update overall celebration
                const streakData = await api.streak.get();
                this.streak = streakData.current_streak;
                this.todayComplete = streakData.today_complete;
                this.lastCompletedDate = streakData.last_completed_date;
                this.updateCelebration(true);
            } catch (error) {
                console.error('Error updating task:', error);
            }
        },

        async togglePunchListTask(task) {
            try {
                if (task.completed_at) {
                    await api.punchList.uncomplete(task.id);
                } else {
                    await api.punchList.complete(task.id);
                }
                await this.loadPunchListTasks();
            } catch (error) {
                console.error('Error toggling punch list task:', error);
            }
        },

        isOverdue(task) {
            if (!task.due_date || task.completed_at) return false;
            const today = new Date().toISOString().split('T')[0];
            return task.due_date < today;
        },

        // Modal handling methods
        closeAddDailyTaskModal() {
            this.showAddDailyTaskModal = false;
            this.newDailyTask = {
                title: '',
                icon: null,
                is_required: true,
                is_active: true
            };
            this.dailyIconSearch = '';
        },

        closeAddTodoModal() {
            this.showAddTodoModal = false;
            this.newTodo = {
                title: '',
                icon: null,
                due_date: null
            };
            this.todoIconSearch = '';
        },

        selectDailyIcon(icon) {
            this.newDailyTask.icon = icon;
            this.showDailyIconPicker = false;
            this.dailyIconSearch = '';
        },

        selectTodoIcon(icon) {
            this.newTodo.icon = icon;
            this.showTodoIconPicker = false;
            this.todoIconSearch = '';
        },

        async submitDailyTask() {
            if (!this.newDailyTask.title.trim()) return;

            try {
                await api.tasks.create({
                    title: this.newDailyTask.title,
                    icon: this.newDailyTask.icon,
                    is_required: this.newDailyTask.is_required,
                    is_active: this.newDailyTask.is_active,
                    frequency: 'daily'
                });

                this.closeAddDailyTaskModal();
                await this.loadDailyTasks();
                toast.success('Daily task created successfully');
            } catch (error) {
                console.error('Error creating daily task:', error);
                toast.error('Failed to create daily task');
            }
        },

        async submitTodo() {
            if (!this.newTodo.title.trim()) return;

            try {
                await api.punchList.create({
                    title: this.newTodo.title,
                    icon: this.newTodo.icon,
                    due_date: this.newTodo.due_date || null
                });

                this.closeAddTodoModal();
                await this.loadPunchListTasks();
                toast.success('Todo created successfully');
            } catch (error) {
                console.error('Error creating todo:', error);
                toast.error('Failed to create todo');
            }
        },

        // All formatters now use global utils.js functions:
        // formatDueDate, formatCompletedDate, formatFitbitProgress, getStreakBadgeClass

        updateCelebration(showToast = false) {
            const milestones = [3, 7, 14, 21, 30, 45, 60, 90, 120, 180, 365];
            const current = this.streak || 0;
            const isMilestone = this.todayComplete && milestones.includes(current);

            if (isMilestone) {
                this.milestoneMessage = `Nice! ${current}-day streak.`;
            } else if (this.todayComplete && current > 0) {
                this.milestoneMessage = `Streak alive â€” ${current} days and counting.`;
            } else {
                this.milestoneMessage = '';
            }

            const nextMilestone = milestones.find((value) => value > current);
            if (this.todayComplete && nextMilestone) {
                const remaining = nextMilestone - current;
                this.nextMilestoneMessage = `${remaining} day${remaining === 1 ? '' : 's'} to your next milestone (${nextMilestone}).`;
            } else {
                this.nextMilestoneMessage = '';
            }

            // Trigger confetti when all required tasks completed
            if (showToast && this.todayComplete && this.completedCount === this.requiredCount && this.requiredCount > 0) {
                const confettiEnabled = localStorage.getItem('streaklet_confetti_enabled');
                if (confettiEnabled === null || confettiEnabled === 'true') {
                    this.triggerConfetti(current);
                }
            }

            if (!showToast || !isMilestone || !this.date) {
                return;
            }

            const storageKey = `streaklet_milestone_${this.date}`;
            const lastShown = localStorage.getItem(storageKey);
            if (lastShown === String(current)) {
                return;
            }

            this.toastMessage = `ðŸŽ‰ ${current}-day streak!`;
            this.showToast = true;
            localStorage.setItem(storageKey, String(current));
            setTimeout(() => {
                this.showToast = false;
            }, 3000);
        },

        celebrateTaskMilestone(task, streak) {
            const confettiEnabled = localStorage.getItem('streaklet_confetti_enabled');
            if (confettiEnabled === 'false') return;

            // Milestone thresholds for per-task celebrations
            const milestones = [3, 7, 14, 21, 30, 45, 60, 90, 100, 180, 365];

            if (!milestones.includes(streak)) return;

            // Show toast notification
            this.toastMessage = `ðŸ”¥ ${task.title}: ${streak}-day streak!`;
            this.showToast = true;
            setTimeout(() => {
                this.showToast = false;
            }, 3000);

            // Trigger smaller confetti burst for task milestone
            if (typeof confetti === 'undefined') return;

            // Scale celebration based on streak tier
            let particleCount = 50;
            let colors = ['#52c41a', '#73d13d', '#95de64'];

            if (streak >= 100) {
                particleCount = 150;
                colors = ['#ffd700', '#ffed4e', '#ffa940'];
            } else if (streak >= 60) {
                particleCount = 100;
                colors = ['#722ed1', '#9254de', '#b37feb'];
            } else if (streak >= 30) {
                particleCount = 80;
                colors = ['#1890ff', '#40a9ff', '#69c0ff'];
            }

            // Single burst from center
            confetti({
                particleCount: particleCount,
                spread: 60,
                origin: { y: 0.6 },
                colors: colors,
                ticks: 150
            });
        },

        triggerConfetti(streakLength) {
            if (typeof confetti === 'undefined') return;

            const streak = streakLength || 1;

            // Simple celebration for days 1-6
            if (streak <= 6) {
                confetti({
                    particleCount: 100,
                    spread: 70,
                    origin: { y: 0.6 },
                    colors: ['#52c41a', '#73d13d', '#95de64']
                });
            }
            // Enhanced for 7+ days
            else {
                confetti({
                    particleCount: 150,
                    spread: 100,
                    origin: { y: 0.6 },
                    colors: ['#52c41a', '#73d13d', '#95de64', '#b7eb8f']
                });
            }
        }
    }
}
</script>

<style>
.task-content {
    display: flex;
    flex-direction: column;
    gap: 4px;
    flex: 1;
}

.task-title {
    font-weight: 500;
}

.fitbit-progress {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: 12px;
    color: #666;
    padding: 2px 8px;
    background: #f0f0f0;
    border-radius: 12px;
    width: fit-content;
}

.fitbit-progress.goal-met {
    background: #e8f5e9;
    color: #2e7d32;
    font-weight: 500;
}

.fitbit-icon {
    font-size: 14px;
    line-height: 1;
}

.empty-state {
    text-align: center;
    padding: 40px 20px;
    color: #999;
}

.empty-state p {
    margin: 0;
    font-size: 14px;
}

/* Add Task Card */
.add-task-card {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 20px;
    margin-bottom: 12px;
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
    border: 2px dashed var(--primary-color);
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.add-task-card:hover {
    background: linear-gradient(135deg, #e3f2fd 0%, #f8f9fa 100%);
    border-color: #1976d2;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(74, 144, 226, 0.15);
}

.add-task-card__text {
    flex: 1;
}

.add-task-card__title {
    font-size: 16px;
    font-weight: 600;
    color: var(--primary-color);
    margin-bottom: 4px;
}

.add-task-card__subtitle {
    font-size: 13px;
    color: #666;
}

/* Icon Picker Button */
.icon-picker-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 60px;
    height: 60px;
    border: 2px solid var(--border-color);
    border-radius: 8px;
    background: white;
    cursor: pointer;
    transition: all 0.2s ease;
    padding: 0;
}

.icon-picker-btn:hover {
    border-color: var(--primary-color);
    background: #f0f7ff;
    transform: scale(1.05);
}

.icon-picker-btn:active {
    transform: scale(0.95);
}

@media (max-width: 480px) {
    .add-task-card {
        padding: 16px;
        gap: 12px;
    }

    .add-task-card i {
        font-size: 28px !important;
    }

    .add-task-card__title {
        font-size: 15px;
    }

    .add-task-card__subtitle {
        font-size: 12px;
    }
}
</style>
{% endblock %}
